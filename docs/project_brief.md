# **项目简报: 内部行情服务原型**

## **执行摘要**

本项目旨在为公司内部构建一个高可用的行情服务快速原型。该服务基于现有的NATS集群，旨在解决内部团队对及时、可靠行情数据的需求，提供一个可以快速部署和使用的中心化数据源。其核心价值在于利用公司现有基础设施，为内部应用和分析提供稳定、高效的数据支持。

## **问题陈述**

1\. 当前状况与痛点:  
内部系统（如量化策略、监控应用）需要实时、可靠的行情数据，而这些数据主要由基于 vnpy 的同步、线程化交易网关（CTP、SOPT）产生。然而，公司内部的现代应用开发倾向于采用异步架构。直接将这两种不同模式的系统集成，会导致代码复杂度高、技术债累积，且难以维护。  
2\. 问题造成的影响:  
这种集成上的不匹配导致了几个负面影响：

* **开发效率低下**：每个需要行情数据的项目都必须独立解决与 vnpy 的线程同步和事件桥接问题。  
* **系统不稳定**：不恰当的跨线程通信容易引发竞态条件、死锁和数据不一致，影响稳定性。  
* **扩展性受限**：点对点的集成方案难以横向扩展，无法支持未来更多内部用户和服务对行情数据的消费需求。

3\. 现有方案的不足:  
目前缺少一个标准化的、企业级的中间层服务。各个项目团队只能采用临时方案，这不仅造成了重复劳动，也使得公司层面无法对行情数据进行统一的管理、监控和优化。  
4\. 紧迫性:  
随着内部对数据驱动决策和自动化交易策略的日益依赖，建立一个统一、高可用的行情服务已成为提升研发效率和系统稳定性的关键瓶瓶颈。一个快速可用的原型将立即为多个项目团队提供支持。

## **解决方案陈述**

1\. 核心概念与方法:  
我们提议构建一个专用的中间件服务，可以称之为“异步网关适配器”。该服务将作为 vnpy 交易网关（如 CTP 和 SOPT）的宿主，在一个独立的线程池中运行和管理它们。服务会捕获 vnpy 事件引擎产生的同步行情事件，然后通过一个安全的事件桥接机制，将这些事件转换并广播到公司内部的 NATS 消息集群中。  
2\. 关键差异化:  
与当前各团队自行集成的临时方案不同，这将是一个中心化、可管理、标准化的服务。它为所有内部应用提供了一个统一、稳定且定义清晰的行情数据接入点。消费者应用（如策略、分析工具）只需连接到NATS，无需关心底层 vnpy 网关的复杂性和同步/异步的转换细节。  
3\. 成功的原因:  
此方案直接采纳并实现了经过验证的 vnpy 异步集成最佳实践，即通过 run\_in\_executor 模式隔离同步代码并安全地桥接事件，能够在保留 vnpy 完整功能的同时，将代码复杂度降低约75%。通过利用NATS集群，整个解决方案在架构上具备了高可用性、解耦和水平扩展的能力。  
4\. 高层愿景:  
最终，我们将为公司打造一个健壮的内部“行情数据总线”。它将成为所有依赖行情数据的应用的基础设施，从而极大地提升公司整体的开发效率、系统稳定性和数据一致性。

## **目标用户**

1. **策略开发者/量化分析师**:  
   * **角色**: 他们是行情数据的**主要消费者**，负责编写和运行交易策略。  
   * **需求**: 需要一个稳定、低延迟、易于订阅的数据源，不希望关心底层vnpy网关的复杂实现细节。他们追求的是数据的实时性和准确性。  
2. **内部应用开发者**:  
   * **角色**: 他们负责开发其他内部系统，如风险控制面板、数据分析平台或监控仪表盘。  
   * **需求**: 需要一个简单、可靠、文档清晰的API（即NATS主题）来获取行情数据，实现与核心交易系统的解耦。  
3. **系统运维工程师 (SRE/Operator)**:  
   * **角色**: 他们是这个行情服务的**部署和维护者**。  
   * **需求**: 关心服务的可观测性（日志、指标）、部署的便捷性（如您在 docker\_dev.md 中规划的）、以及系统的高可用性。

## **目标与成功指标**

### **业务目标 (Business Objectives)**

1. **降低开发摩擦**: 提供一个标准化的行情服务，显著减少内部项目集成vnpy所需的时间和代码复杂度。  
2. **促进应用创新**: 为策略和应用开发团队创建一个稳定的数据基础，使他们能够快速构建新工具和策略的原型，而无需担心底层数据源的集成问题。  
3. **验证技术架构**: 证明我们所选定的“DDD \+ 六边形架构 \+ NATS消息总线” 的技术方案，是未来内部服务一个可行且可扩展的模式。

### **用户成功指标 (User Success Metrics)**

* **对于策略/量化开发者**: **首次数据获取时间 (Time-to-first-tick)**。他们能在多短时间内在一个新项目中完成配置、订阅并成功接收到第一条行情数据。我们追求的目标是将这个时间从过去的数天缩短到几分钟。  
* **对于内部应用开发者**: **集成简易度 (Ease of Integration)**。成功的标准是客户端代码极其简单，仅需几行代码（例如，使用 core.py 中定义的 IPCNode）即可完成集成。  
* **对于系统运维工程师**: **运维简明性 (Operational Simplicity)**。成功的标准是服务可以被轻松地部署、监控和管理，例如通过您在 docker\_dev.md 中定义的容器化方案。

### **关键性能指标 (Key Performance Indicators \- KPIs)**

1. **服务接入时间 \< 30分钟**: 任何一个内部开发者，在拿到文档后，应能在30分钟内完成在本地环境的对接并成功收到实时行情数据。  
2. **原型稳定性 \= 100%**：在为期一周的首轮测试期间，在模拟负载下，服务在交易时段内无计划外中断。  
3. **内部采用率 \>= 2**: 在原型发布后的第一个月内，至少有2个独立的内部团队或项目成功集成并使用该服务。

## **MVP 范围 (Minimum Viable Product Scope)**

### **核心功能 (Must Have)**

1. **CTP网关集成**: 服务必须能够承载一个 vnpy CTP 网关实例，并管理其连接、登录和生命周期。  
2. **异步事件桥接**: 实现核心的同步转异步事件桥接机制。  
3. **NATS 发布器**: 服务必须能将从 vnpy 接收并转换后的行情数据，实时发布（Broadcast）到预定义的 NATS 主题（Channel）上。  
4. **基础配置能力**: 服务需要支持通过环境变量或简单的配置文件来加载 CTP 网关的连接参数。  
5. **容器化封装**: 服务最终必须被打包成一个 Docker 镜像，以便于遵循您已有的模式进行快速部署和管理。

### **范围之外 (Out of Scope for MVP)**

1. **SOPT 网关集成**: MVP 将首先只专注于实现 CTP 网关的集成。  
2. **RPC远程调用**: 本次原型将只实现行情的广播/订阅模式。  
3. **高级可观测性**: 原型将只提供基础的容器日志。  
4. **数据持久化**: 本服务是一个纯粹的实时数据流转通道，不涉及数据库存储。  
5. **图形管理界面**: MVP 不包含任何用于管理或监控服务的 GUI 界面。

### **MVP 成功标准**

* 服务能够成功同时连接到 CTP 交易柜台和 NATS 集群。  
* 来自 CTP 的实时行情数据能够被连续、准确地发布到指定的 NATS 主题上。  
* 至少一个独立的客户端应用，可以通过订阅该 NATS 主题，实时地接收到行情数据。  
* 服务能够以 Docker 容器的形式，稳定运行至少一个完整的交易日。

## **MVP 后续愿景 (Post-MVP Vision)**

### **第二阶段功能 (Phase 2 Features)**

1. **增加 SOPT 网关支持**: 将 vnpy 的 SOPT（期权）网关集成进来，从而在行情总线上同时提供期货和期权的数据。  
2. **实现 RPC 控制平面**: 启用 IPCNode 的远程过程调用 (RPC) 功能，允许其他服务远程查询和管理此服务的状态。  
3. **增强可观测性**: 集成专业的监控工具（如 Prometheus），对外暴露详细的性能指标。

### **长期愿景 (Long-term Vision)**

这个原型将演变为一个企业级的“**行情数据总线 (Market Data Bus)**”，成为公司内所有实时行情数据的唯一可信来源。它将通过服务自身的集群化部署，以及底层NATS集群的冗余能力，最终实现真正的高可用性。

### **扩展机会 (Expansion Opportunities)**

* **接入更多数据源**: 扩展支持更多类型的 vnpy 网关。  
* **开发数据持久化服务**: 创建独立的“存储”服务，订阅总线上的数据并将其持久化到时间序列数据库。  
* **构建管理界面**: 开发一个简单的Web界面用于监控和管理。

## **技术注意事项 (Technical Considerations)**

### **平台要求 (Platform Requirements)**

* **目标平台**: 后端服务，运行于 Linux/Docker 环境中。  
* **性能要求**: 高可用性，以及满足实时行情数据广播的低延迟要求。

### **技术偏好 (Technology Preferences)**

* **后端**: **Python**，并采用 **Asyncio** 进行异步编程。核心库将包括 nats.py 用于消息通信和 Pydantic 用于数据建模与校验。服务本身将作为 vnpy 框架的宿主。  
* **数据库**: MVP阶段不涉及数据持久化，服务是无状态的数据通道，因此**无需数据库**。  
* **托管/基础设施**: 服务将被打包为 **Docker** 容器，并连接到一个 **NATS** 集群进行部署。

### **架构考量 (Architecture Considerations)**

* **代码仓库结构**: 鉴于原型范围，推荐为该服务使用**单一代码仓库 (Single Repository)**。  
* **服务架构**: 服务将遵循\*\*六边形架构（端口与适配器）**模式进行设计，这与您期望的**领域驱动设计(DDD)\*\*核心思想保持一致。  
* **集成要求**:  
  * **输入适配器**: 实现与 vnpy CTP 网关的集成。  
  * **输出适配器**: 实现将行情数据发布到 NATS 集群的功能。

## **限制与假设 (Constraints & Assumptions)**

### **限制 (Constraints)**

1. **时间限制**: 项目的首要限制是**快速交付**。  
2. **技术限制**: 解决方案**必须**使用 Python 开发，并与公司现有的 NATS 集群以及 vnpy CTP 网关进行集成。  
3. **架构限制**: 项目设计**必须**遵循领域驱动设计 (DDD) 和六边形架构的原则。

### **关键假设 (Key Assumptions)**

1. **基础设施可用性**: 我们假设一个稳定、可供开发和测试使用的 NATS 集群已经就绪或可以快速搭建。  
2. **上游数据源可靠性**: 我们假设 vnpy CTP 网关本身及其连接的上游柜台是稳定可靠的。  
3. **目标用户可参与度**: 我们假设目标用户群体（策略开发者等）有时间并愿意参与到原型的测试环节中。  
4. **测试凭证可用性**: 我们假设开发团队能够获取用于连接 CTP 网关的有效测试账户凭证。

## **风险与决策记录 (Risks & Decisions Record)**

### **主要风险 (Key Risks)**

1. **上游源不稳定风险**: vnpy CTP 网关或其连接的柜台API可能存在不稳定的情况，影响服务可用性。  
2. **性能瓶颈风险**: 在高频行情场景下，同步到异步的事件桥接逻辑可能成为性能瓶颈，引入延迟。  
3. **内部推广风险**: 内部目标团队可能因为固有的工作流程而采用缓慢。

### **已解决的关键问题与决策**

* **安全模型**: 经确认，作为内部原型，MVP阶段**无需考虑**复杂的安全机制。  
* **性能目标**: 原型需满足约 **5000条/秒** 的消息处理能力。  
* **数据范式**: 最终数据范式将直接采用 vnpy.trader.object.TickData 结构。  
* **NATS主题结构**: 将采用简洁、必要的层级结构，避免过度设计。

## **附录 (Appendices)**

### **参考资料 (References)**

* docker\_dev.md (NATS 集群部署方案)  
* ctp\_gateway.py (CTP 期货行情网关实现参考)  
* sopt\_gateway.py (SOPT 期权行情网关实现参考)  
* vnpy-integration-best-practices.md (vnpy 异步集成模式)  
* core.py (NATS IPC SDK 实现参考)  
* ddd\_50\_keywords.md (DDD/六边形架构指导原则)

