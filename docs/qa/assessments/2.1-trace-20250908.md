# Requirements Traceability Matrix

## Story: 2.1 - CTP Gateway Adapter Implementation

Date: 2025-09-08
Analyst: Quinn (Test Architect)

### Coverage Summary

- Total Requirements: 5 (from AC1–AC5)
- Fully Covered: 0 (0%) — pre-implementation
- Partially Covered: 0 (0%)
- Not Covered: 5 (100%) — tests to be implemented in this story

Planning reference: docs/qa/assessments/2.1-test-design-20250908.md

### Requirement Mappings (Planned)

Note: Mappings reference the planned tests from the Test Design. Actual test files and cases will be created during implementation.

#### AC1: CTPGatewayAdapter implements MarketDataPort

Coverage: none (planned)

Given-When-Then (planned):
- Unit Test: tests/unit/test_ctp_adapter.py::test_class_initialization
  - Given: Valid configuration
  - When: Construct CTPGatewayAdapter
  - Then: Exposes required methods and initial state is sane

- Unit Test: tests/unit/test_ctp_adapter.py::test_unimplemented_methods_raise
  - Given: Constructed adapter
  - When: Call subscribe/unsubscribe/receive_ticks
  - Then: NotImplementedError raised (to be implemented in Story 2.2)

#### AC2: Connect/login via supervised worker thread; clean shutdown

Coverage: none (planned)

Given-When-Then (planned):
- Unit Test: tests/unit/test_ctp_adapter.py::test_connect_submits_worker
  - Given: Fake executor and shutdown event
  - When: connect() called
  - Then: Worker submitted; running flag true

- Integration Test: tests/unit/test_ctp_adapter.py::test_disconnect_joins_cleanly
  - Given: Connected adapter
  - When: disconnect() called
  - Then: Shutdown signaled and worker joined without deadlock

#### AC3: Supervision with exponential backoff and max retries; structured logs

Coverage: none (planned)

Given-When-Then (planned):
- Unit Test: tests/unit/test_ctp_adapter.py::test_backoff_sequence_and_retry_cap
  - Given: Worker fails repeatedly
  - When: Supervision loop runs
  - Then: Backoff ~=[0.5,1.0,2.0]; stops after 3 attempts

- Unit Test: tests/unit/test_ctp_adapter.py::test_structured_logs_on_retry
  - Given: Failure causing retry
  - When: Logging occurs
  - Then: Logs contain fields {attempt, reason, next_backoff}

#### AC4: Config fields + address normalization; vnpy key mapping

Coverage: none (planned)

Given-When-Then (planned):
- Unit Test: tests/unit/test_ctp_adapter.py::test_vnpy_key_mapping
  - Given: Config with broker/user/password/md/td/app_id/auth_code
  - When: Build vnpy setting dict
  - Then: Chinese keys mapping as specified

- Unit Test: tests/unit/test_ctp_adapter.py::test_address_normalization
  - Given: Endpoints missing scheme
  - When: Normalize addresses
  - Then: tcp:// added when missing; ssl:// preserved

- Unit Test: tests/unit/test_ctp_adapter.py::test_to_dict_safe_masks_secrets
  - Given: Config with sensitive values
  - When: Call to_dict_safe()
  - Then: Secrets masked; no sensitive data in output

#### AC5: Unit tests validate lifecycle, supervision, and config mapping

Coverage: none (planned)

Given-When-Then (planned):
- Integration Test: tests/unit/test_ctp_adapter.py::test_failure_then_restart_then_stop
  - Given: Worker fails then recovers
  - When: Supervision loop runs
  - Then: Retries happen with expected backoff; stops as configured

### Critical Gaps

1. No tests implemented yet (pre-dev state)
   - Risk: High — Reliability and security requirements unverified
   - Action: Implement P0 scenarios from test design first

2. Secret handling not validated
   - Risk: High — Potential credential leakage
   - Action: Add masking tests and ensure logs do not contain secrets

### Test Design Recommendations

Follow docs/qa/assessments/2.1-test-design-20250908.md execution order:
1) P0 Unit → 2) P0 Integration → 3) Remaining P1/P2

### Risk Assessment Linkage

Mitigates risks from docs/qa/assessments/2.1-risk-20250908.md: OPS-001, SEC-001, TECH-002, BUS-001, DATA-001.

### Gate Block (for inclusion)

```yaml
trace:
  totals:
    requirements: 5
    full: 0
    partial: 0
    none: 5
  planning_ref: 'qa.qaLocation/assessments/2.1-test-design-20250908.md'
  uncovered: []
  notes: 'See qa.qaLocation/assessments/2.1-trace-20250908.md'
```

### Story Hook Line

Trace matrix: qa.qaLocation/assessments/2.1-trace-20250908.md
