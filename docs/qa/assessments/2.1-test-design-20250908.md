# Test Design: Story 2.1 - CTP Gateway Adapter Implementation

Date: 2025-09-08
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 12
- Unit tests: 9 (75%)
- Integration tests: 3 (25%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 6, P1: 5, P2: 1

Rationale: This story focuses on a synchronous input adapter running inside a supervised thread with retry/backoff and sensitive credential mapping. Most logic is deterministic and unit-testable with fakes; limited integration tests validate thread lifecycle and supervision timing.

## Test Scenarios by Acceptance Criteria

### AC1: CTPGatewayAdapter implements MarketDataPort
Adapter class exists and exposes required methods; non-implemented methods explicitly raise until Story 2.2.

#### Scenarios

| ID            | Level | Priority | Test                                                                 | Justification |
| ------------- | ----- | -------- | -------------------------------------------------------------------- | ------------- |
| 2.1-UNIT-001  | Unit  | P1       | Class constructs with config dependency; attributes initialized       | Basic class contract sanity |
| 2.1-UNIT-002  | Unit  | P2       | subscribe/unsubscribe/receive_ticks raise NotImplementedError (2.2)  | Explicit contract until Story 2.2 |

### AC2: Connect/login via supervised worker thread; clean shutdown
connect() starts supervised worker in ThreadPoolExecutor; disconnect() signals and joins cleanly.

#### Scenarios

| ID            | Level       | Priority | Test                                                                 | Justification |
| ------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 2.1-UNIT-003  | Unit        | P0       | connect() submits worker; future running; internal flags set         | Deterministic state check with fake executor |
| 2.1-INT-001   | Integration | P0       | End-to-end: connect() then disconnect() joins without deadlock       | Thread lifecycle correctness |
| 2.1-INT-002   | Integration | P1       | Worker exits on shutdown event set during disconnect()                | Proper cooperative shutdown |

### AC3: Supervision with exponential backoff and max retries; structured logs
Backoff sequence approx [0.5, 1.0, 2.0]; capped retries=3; logs include {attempt, reason, next_backoff}.

#### Scenarios

| ID            | Level | Priority | Test                                                                 | Justification |
| ------------- | ----- | -------- | -------------------------------------------------------------------- | ------------- |
| 2.1-UNIT-004  | Unit  | P0       | On failure, retry loop triggers with backoff seq ~= [0.5,1.0,2.0]     | Core reliability behavior |
| 2.1-UNIT-005  | Unit  | P0       | Stops after max_retries=3; no additional attempts                     | Prevents hot-loop storm |
| 2.1-UNIT-006  | Unit  | P0       | Logs contain attempt, reason, next_backoff fields per retry           | Observability requirement |

### AC4: Config fields for CTP and address normalization; vnpy key mapping
Settings include broker/user/password/md/td/app_id/auth_code; normalize prefixes; build vnpy setting dict with Chinese keys.

#### Scenarios

| ID            | Level | Priority | Test                                                                 | Justification |
| ------------- | ----- | -------- | -------------------------------------------------------------------- | ------------- |
| 2.1-UNIT-007  | Unit  | P0       | Build vnpy setting mapping uses required Chinese keys correctly       | Integration contract with vnpy |
| 2.1-UNIT-008  | Unit  | P1       | Address normalization adds tcp:// if missing; preserves ssl://        | Correct endpoint normalization |
| 2.1-UNIT-009  | Unit  | P1       | Sensitive values masked in to_dict_safe()                             | Security requirement |

### AC5: Unit tests validate lifecycle, supervision, and config mapping
Tests themselves must cover successful connect, failure→restart path, clean shutdown, mapping/normalization.

#### Scenarios

| ID            | Level       | Priority | Test                                                                 | Justification |
| ------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 2.1-INT-003   | Integration | P1       | Failure→restart path observed with expected backoff; final stop      | Validates retry behavior in realistic threading |
| 2.1-UNIT-010  | Unit        | P1       | Config mapping + normalization covered by pure unit tests             | Deterministic config behavior |

## Risk Coverage

If used with risk profile, these scenarios mitigate: TECH-002, OPS-001, SEC-001, PERF-001, DATA-001.

## Recommended Execution Order

1. P0 Unit tests (2.1-UNIT-004, -005, -006, -007)
2. P0 Integration tests (2.1-INT-001)
3. Remaining P1/P2 Unit tests
4. Remaining Integration tests (2.1-INT-002, -003)

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 12
  by_level:
    unit: 9
    integration: 3
    e2e: 0
  by_priority:
    p0: 6
    p1: 5
    p2: 1
  coverage_gaps: []
```

## Trace References

Test design matrix: qa.qaLocation/assessments/2.1-test-design-20250908.md
P0 tests identified: 6
