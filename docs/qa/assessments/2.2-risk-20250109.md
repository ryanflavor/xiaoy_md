# Risk Profile: Story 2.2 - Sync-to-Async Event Bridge

Date: 2025-01-09
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 15
- Critical Risks: 3
- High Risks: 4
- Medium Risks: 5
- Low Risks: 3
- Risk Score: 25/100 (High Risk - Requires significant mitigation)

## Critical Risks Requiring Immediate Attention

### 1. [DATA-001]: Market Tick Data Loss on Queue Overflow

**Score: 9 (Critical)**
**Probability**: High - With high-frequency market data during volatile periods, a 1000-item queue can overflow within seconds
**Impact**: High - Lost market ticks directly impact trading decisions, position calculations, and P&L reporting
**Mitigation**:
- Implement dynamic queue sizing based on tick rate monitoring
- Add backpressure signaling to upstream vnpy gateway
- Create tiered dropping strategy (keep latest price, drop intermediate)
- Monitor queue depth with alerts at 70%, 90% thresholds
**Testing Focus**: Load test with burst scenarios (10,000 ticks/second), verify graceful degradation

### 2. [TECH-001]: Thread Safety Violation in Cross-Thread Communication

**Score: 9 (Critical)**
**Probability**: High - asyncio.run_coroutine_threadsafe has subtle race conditions if loop stops
**Impact**: High - Application crash, corrupted state, undefined behavior
**Mitigation**:
- Verify loop is running before each bridge attempt
- Implement proper exception handling around run_coroutine_threadsafe
- Add thread-safe shutdown coordination mechanism
- Use asyncio.Lock for queue operations if needed
**Testing Focus**: Concurrent shutdown tests, thread race condition simulation

### 3. [DATA-002]: Timezone Conversion Errors Causing Wrong Timestamps

**Score: 9 (Critical)**
**Probability**: High - China timezone (Asia/Shanghai) to UTC conversion is error-prone during DST transitions
**Impact**: High - Wrong timestamps affect order timing, audit trails, regulatory compliance
**Mitigation**:
- Use ZoneInfo with explicit timezone handling
- Add timestamp validation post-conversion
- Log both original and converted timestamps
- Implement sanity checks (future timestamps detection)
**Testing Focus**: DST boundary testing, historical data replay with known timestamps

## High Risk Areas

### 4. [PERF-001]: Translation Overhead Causing Latency Spikes

**Score: 6 (High)**
**Probability**: Medium - Object creation and field mapping adds 1-5ms per tick
**Impact**: High - In HFT scenarios, 5ms latency is unacceptable
**Mitigation**:
- Profile translation method for optimization opportunities
- Consider using __slots__ for MarketTick objects
- Pre-allocate objects where possible
- Implement translation result caching for duplicate ticks

### 5. [DATA-003]: Contract Symbol Mapping Failures

**Score: 6 (High)**
**Probability**: High - New contracts or symbol changes can break mapping
**Impact**: Medium - Ticks for unmapped contracts are silently dropped
**Mitigation**:
- Add explicit logging for unmapped symbols
- Implement contract discovery mechanism
- Create symbol mapping validation on startup
- Add metrics for dropped ticks by symbol

### 6. [OPS-001]: Insufficient Observability During Production Issues

**Score: 6 (High)**
**Probability**: Medium - Complex async/thread interactions are hard to debug
**Impact**: High - Production issues take hours to diagnose
**Mitigation**:
- Add structured logging with correlation IDs
- Implement tick flow tracing
- Add queue depth metrics to monitoring
- Create debug mode with verbose logging

### 7. [TECH-002]: Memory Leak from Uncleaned Queues

**Score: 6 (High)**
**Probability**: Medium - Disconnect without queue.clear() leaves objects in memory
**Impact**: High - Long-running process exhausts memory
**Mitigation**:
- Ensure queue.clear() in all disconnect paths
- Add memory profiling tests
- Implement queue size monitoring
- Use weak references where appropriate

## Medium Risk Areas

### 8. [PERF-002]: Queue Blocking Causing Event Loop Starvation

**Score: 4 (Medium)**
**Probability**: Medium - queue.put() can block if misconfigured
**Impact**: Medium - Degraded performance for other async tasks
**Mitigation**:
- Use put_nowait() with explicit full handling
- Monitor event loop lag
- Implement queue drain mechanism

### 9. [DATA-004]: MAX_FLOAT Conversion Causing Invalid Prices

**Score: 4 (Medium)**
**Probability**: Medium - vnpy uses sys.float_info.max for null values
**Impact**: Medium - Invalid prices in downstream systems
**Mitigation**:
- Explicit MAX_FLOAT detection and conversion
- Add price sanity validation
- Log suspicious price values

### 10. [TECH-003]: AsyncIO Loop Reference Becomes Stale

**Score: 4 (Medium)**
**Probability**: Low - Loop recreation is rare but possible
**Impact**: High - Complete failure of tick bridging
**Mitigation**:
- Validate loop reference before use
- Implement loop recreation detection
- Add health check for bridge functionality

### 11. [OPS-002]: Inadequate Error Recovery Mechanisms

**Score: 4 (Medium)**
**Probability**: Medium - Errors in tick processing are likely
**Impact**: Medium - Manual intervention required
**Mitigation**:
- Implement automatic retry logic
- Add circuit breaker pattern
- Create error recovery procedures

### 12. [BUS-001]: Delayed Market Data Affecting Trading Decisions

**Score: 4 (Medium)**
**Probability**: Medium - Queue processing adds latency
**Impact**: Medium - Suboptimal trading decisions
**Mitigation**:
- Add timestamp-based priority processing
- Implement tick conflation for high-frequency symbols
- Monitor end-to-end latency

## Low Risk Areas

### 13. [TECH-004]: Exchange Enum Translation Failures

**Score: 3 (Low)**
**Probability**: Low - EXCHANGE_CTP2VT mapping is stable
**Impact**: High - Ticks routed to wrong exchange
**Mitigation**:
- Validate exchange mapping on startup
- Add unknown exchange handling

### 14. [OPS-003]: Logging Volume Overwhelming Storage

**Score: 2 (Low)**
**Probability**: Low - Structured logging is efficient
**Impact**: Medium - Disk space issues
**Mitigation**:
- Implement log rotation
- Use appropriate log levels
- Add log sampling for high-frequency events

### 15. [DATA-005]: Bid/Ask Field Mapping Inconsistencies

**Score: 2 (Low)**
**Probability**: Low - Field names are documented
**Impact**: Medium - Incorrect spread calculations
**Mitigation**:
- Add field mapping tests
- Validate bid < ask invariant

## Risk Distribution

### By Category
- Technical: 4 risks (1 critical, 1 high, 1 medium, 1 low)
- Data: 5 risks (2 critical, 1 high, 2 medium)
- Performance: 2 risks (1 high, 1 medium)
- Operational: 3 risks (1 high, 1 medium, 1 low)
- Business: 1 risk (1 medium)

### By Component
- Event Bridge (on_tick): 6 risks
- Queue Management: 4 risks
- Translation Layer: 3 risks
- Monitoring/Logging: 2 risks

## Detailed Risk Register

| Risk ID  | Category | Description | Probability | Impact | Score | Priority |
|----------|----------|-------------|-------------|---------|--------|----------|
| DATA-001 | Data | Market tick data loss on queue overflow | High (3) | High (3) | 9 | Critical |
| TECH-001 | Technical | Thread safety violation | High (3) | High (3) | 9 | Critical |
| DATA-002 | Data | Timezone conversion errors | High (3) | High (3) | 9 | Critical |
| PERF-001 | Performance | Translation overhead latency | Medium (2) | High (3) | 6 | High |
| DATA-003 | Data | Contract symbol mapping failures | High (3) | Medium (2) | 6 | High |
| OPS-001 | Operational | Insufficient observability | Medium (2) | High (3) | 6 | High |
| TECH-002 | Technical | Memory leak from queues | Medium (2) | High (3) | 6 | High |
| PERF-002 | Performance | Queue blocking event loop | Medium (2) | Medium (2) | 4 | Medium |
| DATA-004 | Data | MAX_FLOAT conversion issues | Medium (2) | Medium (2) | 4 | Medium |
| TECH-003 | Technical | Stale loop reference | Low (1) | High (3) | 3 | Medium |
| OPS-002 | Operational | Inadequate error recovery | Medium (2) | Medium (2) | 4 | Medium |
| BUS-001 | Business | Delayed market data | Medium (2) | Medium (2) | 4 | Medium |
| TECH-004 | Technical | Exchange enum failures | Low (1) | High (3) | 3 | Low |
| OPS-003 | Operational | Log volume issues | Low (1) | Medium (2) | 2 | Low |
| DATA-005 | Data | Bid/ask mapping issues | Low (1) | Medium (2) | 2 | Low |

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests
- **Load Testing**: Simulate 10,000 ticks/second to test queue overflow handling
- **Thread Safety Testing**: Concurrent operations with thread sanitizer
- **Timezone Testing**: Test with historical data across DST boundaries
- **Chaos Engineering**: Random thread interruption and loop recreation

### Priority 2: High Risk Tests
- **Performance Testing**: Measure translation latency under load
- **Contract Mapping Tests**: Test with unknown symbols
- **Memory Leak Testing**: Long-running tests with memory profiling
- **Observability Testing**: Verify all log points and metrics

### Priority 3: Medium/Low Risk Tests
- **Integration Tests**: Full flow from vnpy to async queue
- **Error Recovery Tests**: Simulate various failure modes
- **Edge Case Tests**: MAX_FLOAT values, null fields, malformed data

## Risk Acceptance Criteria

### Must Fix Before Production
- All critical risks (DATA-001, TECH-001, DATA-002)
- Queue overflow handling mechanism
- Thread-safe shutdown coordination
- Timezone conversion validation

### Can Deploy with Mitigation
- Performance risks with monitoring in place
- Observability gaps with enhanced logging
- Memory concerns with restart procedures

### Accepted Risks
- Log volume (with rotation policy)
- Minor latency from translation (< 5ms acceptable)

## Monitoring Requirements

Post-deployment monitoring for:
- **Queue Metrics**: Depth, overflow rate, drop rate
- **Latency Metrics**: Translation time, end-to-end tick latency
- **Error Rates**: Failed translations, unmapped symbols
- **Resource Metrics**: Memory usage, thread count
- **Business Metrics**: Ticks processed/second by symbol

## Risk Review Triggers

Review and update risk profile when:
- Tick volume increases by 50%
- New exchanges or instruments added
- AsyncIO framework updates
- Performance degradation observed
- Memory usage anomalies detected

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 3
    high: 4
    medium: 5
    low: 3
  highest:
    id: DATA-001
    score: 9
    title: 'Market tick data loss on queue overflow'
  recommendations:
    must_fix:
      - 'Implement dynamic queue sizing with backpressure'
      - 'Add thread-safe shutdown coordination'
      - 'Fix timezone conversion with validation'
    monitor:
      - 'Queue depth and overflow metrics'
      - 'Translation latency per tick'
      - 'Memory usage trends'
```

Risk profile: docs/qa/assessments/2.2-risk-20250109.md
