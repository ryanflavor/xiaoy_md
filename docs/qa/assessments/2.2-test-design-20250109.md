# Test Design: Story 2.2 - Sync-to-Async Event Bridge

Date: 2025-01-09
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 47
- Unit tests: 28 (59.6%)
- Integration tests: 14 (29.8%)
- E2E tests: 5 (10.6%)
- Priority distribution: P0: 18, P1: 16, P2: 10, P3: 3

## Test Philosophy

Given the critical nature of market data processing and the identified risks (3 critical, 4 high), this test design emphasizes:
1. **Comprehensive unit testing** for thread safety and data integrity
2. **Focused integration testing** for async/sync bridging
3. **Strategic E2E testing** for critical market data flows
4. **Risk-driven prioritization** addressing all critical risks

## Test Scenarios by Acceptance Criteria

### AC1: Adapter overrides on_tick() method to capture vnpy TickData in executor thread

#### Core Functionality Tests

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.2-UNIT-001 | Unit | P0 | Verify on_tick method signature matches BaseGateway | Inheritance contract validation | TECH-004 |
| 2.2-UNIT-002 | Unit | P0 | Test on_tick handles valid TickData object | Core functionality | - |
| 2.2-UNIT-003 | Unit | P0 | Test on_tick ignores ticks without contract data | Prevent processing invalid symbols | DATA-003 |
| 2.2-UNIT-004 | Unit | P1 | Test on_tick with null/empty symbol | Edge case handling | DATA-003 |
| 2.2-UNIT-005 | Unit | P1 | Test on_tick with special characters in symbol | Symbol validation | DATA-003 |
| 2.2-INT-001 | Integration | P0 | Verify on_tick called from executor thread | Thread context validation | TECH-001 |
| 2.2-INT-002 | Integration | P1 | Test on_tick with rapid successive calls | High-frequency handling | PERF-001 |

#### Queue Management Tests

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.2-UNIT-006 | Unit | P0 | Test queue initialization with maxsize=1000 | Queue configuration | DATA-001 |
| 2.2-UNIT-007 | Unit | P0 | Test queue.full() detection | Overflow prevention | DATA-001 |
| 2.2-UNIT-008 | Unit | P0 | Test drop counter increment on full queue | Metrics accuracy | DATA-001 |
| 2.2-UNIT-009 | Unit | P1 | Test queue.clear() on disconnect | Memory cleanup | TECH-002 |
| 2.2-INT-003 | Integration | P0 | Test queue overflow with 1000+ rapid ticks | Backpressure handling | DATA-001 |
| 2.2-INT-004 | Integration | P1 | Test queue memory usage over time | Memory leak detection | TECH-002 |

### AC2: Uses asyncio.run_coroutine_threadsafe() to bridge TickData to main loop's asyncio.Queue

#### Translation Layer Tests

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.2-UNIT-010 | Unit | P0 | Test vnpy TickData to MarketTick translation | Data mapping correctness | - |
| 2.2-UNIT-011 | Unit | P0 | Test timezone conversion (Asia/Shanghai to UTC) | Timestamp accuracy | DATA-002 |
| 2.2-UNIT-012 | Unit | P0 | Test DST boundary timezone conversion | DST edge cases | DATA-002 |
| 2.2-UNIT-013 | Unit | P0 | Test MAX_FLOAT to 0 conversion | Null value handling | DATA-004 |
| 2.2-UNIT-014 | Unit | P1 | Test exchange enum translation | Exchange mapping | TECH-004 |
| 2.2-UNIT-015 | Unit | P1 | Test bid/ask price field mapping | Market depth accuracy | DATA-005 |
| 2.2-UNIT-016 | Unit | P2 | Test translation with missing optional fields | Partial data handling | - |
| 2.2-UNIT-017 | Unit | P2 | Test translation performance (<1ms) | Latency validation | PERF-001 |

#### Async Bridge Tests

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.2-UNIT-018 | Unit | P0 | Test run_coroutine_threadsafe with valid loop | Core bridging | TECH-001 |
| 2.2-UNIT-019 | Unit | P0 | Test handling of stopped event loop | Error resilience | TECH-001, TECH-003 |
| 2.2-UNIT-020 | Unit | P0 | Test main_loop reference storage | Loop lifecycle | TECH-003 |
| 2.2-INT-005 | Integration | P0 | Test cross-thread queue.put() | Thread safety | TECH-001 |
| 2.2-INT-006 | Integration | P0 | Test concurrent on_tick calls | Race condition handling | TECH-001 |
| 2.2-INT-007 | Integration | P1 | Test bridge during loop recreation | Loop refresh handling | TECH-003 |
| 2.2-E2E-001 | E2E | P0 | Test full flow: vnpy tick â†’ async queue | End-to-end validation | - |

#### Async Receiver Tests

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.2-UNIT-021 | Unit | P0 | Test receive_ticks() async generator | Iterator protocol | - |
| 2.2-UNIT-022 | Unit | P0 | Test receive_ticks() with CancelledError | Clean shutdown | OPS-002 |
| 2.2-UNIT-023 | Unit | P1 | Test receive_ticks() queue.get() timeout | Blocking prevention | PERF-002 |
| 2.2-INT-008 | Integration | P0 | Test async iteration over bridged ticks | Consumer pattern | - |
| 2.2-INT-009 | Integration | P1 | Test multiple consumers on same queue | Concurrency safety | - |

### AC3: Unit tests verify the bridging mechanism including contract validation and timezone conversion

#### Test Coverage Validation

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.2-UNIT-024 | Unit | P0 | Test contract validation before processing | Data integrity | DATA-003 |
| 2.2-UNIT-025 | Unit | P0 | Test symbol_contract_map lookup | Contract resolution | DATA-003 |
| 2.2-UNIT-026 | Unit | P1 | Test AAA pattern compliance in all tests | Test quality | - |
| 2.2-UNIT-027 | Unit | P2 | Test mock usage for vnpy dependencies | Test isolation | - |
| 2.2-UNIT-028 | Unit | P2 | Test correlation with acceptance criteria | Traceability | - |

### Performance and Load Tests

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.2-INT-010 | Integration | P0 | Load test: 10,000 ticks/second | Peak load handling | DATA-001, PERF-001 |
| 2.2-INT-011 | Integration | P1 | Sustained load: 1,000 ticks/sec for 1 hour | Memory stability | TECH-002 |
| 2.2-INT-012 | Integration | P1 | Burst test: 50,000 ticks in 1 second | Burst resilience | DATA-001 |
| 2.2-E2E-002 | E2E | P1 | Market hours simulation (8 hours) | Production readiness | BUS-001 |

### Observability and Error Handling Tests

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.2-INT-013 | Integration | P0 | Test structured JSON logging output | Observability | OPS-001 |
| 2.2-INT-014 | Integration | P1 | Test error recovery mechanisms | Resilience | OPS-002 |
| 2.2-E2E-003 | E2E | P1 | Test monitoring metrics accuracy | Production visibility | OPS-001 |

### Chaos and Resilience Tests

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.2-E2E-004 | E2E | P1 | Chaos: Random thread interruption | Thread safety validation | TECH-001 |
| 2.2-E2E-005 | E2E | P2 | Chaos: Event loop recreation | Loop reference handling | TECH-003 |

### Edge Cases and Boundary Tests

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.2-UNIT-029 | Unit | P2 | Test with maximum symbol length (30 chars) | Boundary validation | - |
| 2.2-UNIT-030 | Unit | P2 | Test with minimum tick data fields | Minimal data handling | - |
| 2.2-UNIT-031 | Unit | P3 | Test with future timestamps | Time validation | DATA-002 |
| 2.2-UNIT-032 | Unit | P3 | Test with negative prices | Data validation | DATA-004 |
| 2.2-UNIT-033 | Unit | P3 | Test with zero volume | Edge case handling | - |

## Risk Coverage Matrix

| Risk ID | Severity | Test Coverage | Test IDs |
|---------|----------|---------------|----------|
| DATA-001 | Critical | High | 2.2-UNIT-006/007/008, 2.2-INT-003/010/012 |
| TECH-001 | Critical | High | 2.2-UNIT-018/019, 2.2-INT-005/006, 2.2-E2E-004 |
| DATA-002 | Critical | High | 2.2-UNIT-011/012/031 |
| PERF-001 | High | Medium | 2.2-UNIT-017, 2.2-INT-002/010 |
| DATA-003 | High | High | 2.2-UNIT-003/004/005/024/025 |
| OPS-001 | High | Medium | 2.2-INT-013, 2.2-E2E-003 |
| TECH-002 | High | Medium | 2.2-UNIT-009, 2.2-INT-004/011 |
| PERF-002 | Medium | Medium | 2.2-UNIT-023 |
| DATA-004 | Medium | High | 2.2-UNIT-013/032 |
| TECH-003 | Medium | Medium | 2.2-UNIT-019/020, 2.2-INT-007, 2.2-E2E-005 |
| OPS-002 | Medium | Medium | 2.2-UNIT-022, 2.2-INT-014 |
| BUS-001 | Medium | Low | 2.2-E2E-002 |
| TECH-004 | Low | Medium | 2.2-UNIT-001/014 |
| OPS-003 | Low | Not tested | - |
| DATA-005 | Low | Medium | 2.2-UNIT-015 |

## Recommended Execution Order

### Phase 1: Critical Path Validation (Day 1)
1. **P0 Unit tests** (18 tests) - Fail fast on fundamental issues
   - Contract validation tests
   - Translation accuracy tests
   - Thread safety tests
2. **P0 Integration tests** (5 tests) - Validate bridging mechanism
   - Cross-thread communication
   - Queue overflow handling

### Phase 2: Risk Mitigation (Day 2)
3. **P0 E2E test** (1 test) - End-to-end flow validation
4. **P1 Unit tests** (9 tests) - Edge cases and error handling
5. **P1 Integration tests** (6 tests) - Load and concurrency testing

### Phase 3: Comprehensive Coverage (Day 3)
6. **P1 E2E tests** (3 tests) - Production simulation
7. **P2 tests** (10 tests) - Additional coverage
8. **P3 tests** (3 tests) - Nice-to-have edge cases

## Test Implementation Guidelines

### Unit Test Structure
```python
def test_on_tick_ignores_unmapped_symbol():
    """Test that on_tick ignores ticks for unmapped symbols [AC1]"""
    # Arrange
    adapter = CTPGatewayAdapter()
    tick = create_mock_tick(symbol="UNKNOWN")

    # Act
    adapter.on_tick(tick)

    # Assert
    assert adapter.queue.qsize() == 0
    assert_risk_mitigated("DATA-003")
```

### Integration Test Structure
```python
async def test_cross_thread_queue_put():
    """Test thread-safe queue.put via run_coroutine_threadsafe [AC2]"""
    # Arrange
    adapter = await setup_adapter_with_thread()
    ticks = generate_test_ticks(count=100)

    # Act
    results = await simulate_cross_thread_ticks(adapter, ticks)

    # Assert
    assert_no_race_conditions(results)
    assert_risk_mitigated("TECH-001")
```

### Load Test Structure
```python
async def test_10k_ticks_per_second():
    """Load test: 10,000 ticks/second [AC2]"""
    # Arrange
    adapter = await setup_high_performance_adapter()
    tick_generator = HighFrequencyTickGenerator(rate=10000)

    # Act
    metrics = await run_load_test(adapter, tick_generator, duration=10)

    # Assert
    assert metrics.dropped_rate < 0.01  # Less than 1% drops
    assert metrics.avg_latency < 5  # Less than 5ms latency
    assert_risk_mitigated("DATA-001", "PERF-001")
```

## Test Data Requirements

### Market Data Scenarios
1. **Normal market conditions**: 100-500 ticks/second
2. **Volatile market**: 1,000-5,000 ticks/second
3. **Market open burst**: 10,000+ ticks in first second
4. **Quiet periods**: 1-10 ticks/second
5. **Network reconnection**: Resume with 1,000 queued ticks

### Symbol Variations
- Standard symbols: "CU2501", "AG2502"
- Special characters: "IF2501-C-5000"
- Maximum length: "VERYLONGSYMBOLNAME1234567890"
- Invalid symbols: "", null, "UNKNOWN"

### Timestamp Scenarios
- Normal trading hours (09:00-15:00 CST)
- Pre-market (08:30-09:00 CST)
- After-hours (15:00-15:30 CST)
- DST transition dates
- Weekend/holiday timestamps

## Quality Metrics

### Coverage Targets
- Line coverage: > 95%
- Branch coverage: > 90%
- Risk coverage: 100% for critical/high risks
- AC coverage: 100%

### Performance Targets
- Translation latency: < 1ms average, < 5ms P99
- Queue operations: < 100Î¼s
- Memory growth: < 1MB per 100,000 ticks
- Drop rate: < 0.1% under normal load, < 1% under peak

## Test Maintenance Strategy

### Continuous Validation
- Run P0 tests on every commit
- Run P0+P1 tests on every PR
- Run full suite nightly
- Load tests weekly

### Test Evolution
- Add tests for new symbol types
- Update timezone tests for DST changes
- Enhance load tests based on production metrics
- Add chaos scenarios from incident reports

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 47
  by_level:
    unit: 28
    integration: 14
    e2e: 5
  by_priority:
    p0: 18
    p1: 16
    p2: 10
    p3: 3
  coverage_gaps: []  # All ACs have test coverage
  risk_coverage:
    critical: 100%  # All 3 critical risks covered
    high: 100%      # All 4 high risks covered
    medium: 100%    # All 5 medium risks covered
    low: 67%        # 2 of 3 low risks covered
```

Test design matrix: docs/qa/assessments/2.2-test-design-20250109.md
P0 tests identified: 18

## Key Testing Insights

1. **Thread Safety is Paramount**: Given the async/sync bridge nature, thread safety tests are critical
2. **Load Testing Essential**: Market data is high-frequency; performance under load must be validated
3. **Timezone Complexity**: CST to UTC conversion with DST requires thorough testing
4. **Queue Management Critical**: Overflow handling directly impacts data integrity
5. **Observability Required**: Complex threading makes debugging difficult without proper logging
