# Test Design: Story 1.4

Date: 2025-09-05
Designer: Quinn (Test Architect)

## Test Strategy Overview

**Ultra-Detailed Test Design for Docker Containerization**

- **Total test scenarios**: 42
- **Unit tests**: 18 (43%)
- **Integration tests**: 16 (38%)
- **E2E tests**: 8 (19%)
- **Priority distribution**: P0: 15, P1: 12, P2: 10, P3: 5

## Test Scenarios by Acceptance Criteria

### AC1: Multi-stage Dockerfile created

#### Unit Test Scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 1.4-UNIT-001 | Unit | P0 | Validate Dockerfile syntax | Pure parsing logic | TECH-001 |
| 1.4-UNIT-002 | Unit | P0 | Verify multi-stage structure | Static analysis | TECH-002 |
| 1.4-UNIT-003 | Unit | P0 | Check base image specification | Configuration validation | SEC-001 |
| 1.4-UNIT-004 | Unit | P0 | Validate USER directive exists | Security requirement | SEC-003 |
| 1.4-UNIT-005 | Unit | P1 | Verify HEALTHCHECK instruction | Reliability check | OPS-002 |
| 1.4-UNIT-006 | Unit | P1 | Check ENTRYPOINT format | Startup validation | TECH-001 |
| 1.4-UNIT-007 | Unit | P2 | Validate ENV variables | Configuration check | DATA-001 |
| 1.4-UNIT-008 | Unit | P2 | Check WORKDIR consistency | Path validation | TECH-001 |
| 1.4-UNIT-009 | Unit | P3 | Verify LABEL metadata | Documentation | - |

#### Integration Test Scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 1.4-INT-001 | Integration | P0 | Build Docker image successfully | Multi-component process | OPS-001 |
| 1.4-INT-002 | Integration | P0 | Verify dependency installation | Package management | TECH-002 |
| 1.4-INT-003 | Integration | P0 | Test layer optimization | Build efficiency | PERF-001 |
| 1.4-INT-004 | Integration | P0 | Validate non-root user runtime | Security validation | SEC-003 |
| 1.4-INT-005 | Integration | P1 | Test build cache usage | Performance | PERF-001 |
| 1.4-INT-006 | Integration | P1 | Verify file copying between stages | Data integrity | DATA-001 |
| 1.4-INT-007 | Integration | P1 | Check final image size < 200MB | Requirement | PERF-002 |
| 1.4-INT-008 | Integration | P2 | Test .dockerignore effectiveness | Security | SEC-002 |

#### E2E Test Scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 1.4-E2E-001 | E2E | P0 | Container starts and runs application | Critical path | BUS-001 |
| 1.4-E2E-002 | E2E | P0 | Health check endpoint responds | Orchestration ready | OPS-002 |
| 1.4-E2E-003 | E2E | P1 | Graceful shutdown on SIGTERM | Reliability | OPS-003 |
| 1.4-E2E-004 | E2E | P2 | Logs visible via docker logs | Observability | DATA-002 |

### AC2: CI pipeline updated for Docker build

#### Unit Test Scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 1.4-UNIT-010 | Unit | P0 | Validate CI YAML syntax | Configuration check | OPS-001 |
| 1.4-UNIT-011 | Unit | P0 | Check build step dependencies | Pipeline logic | BUS-001 |
| 1.4-UNIT-012 | Unit | P1 | Verify build timeout configuration | Reliability | OPS-004 |
| 1.4-UNIT-013 | Unit | P1 | Validate Docker Buildx setup | Caching logic | PERF-001 |
| 1.4-UNIT-014 | Unit | P2 | Check commit SHA tagging | Traceability | - |
| 1.4-UNIT-015 | Unit | P2 | Verify build-only (no push) | Security | OPS-001 |
| 1.4-UNIT-016 | Unit | P3 | Validate build log capture | Debugging | - |
| 1.4-UNIT-017 | Unit | P3 | Check error handling | Pipeline resilience | - |
| 1.4-UNIT-018 | Unit | P3 | Verify artifact handling | Build output | - |

#### Integration Test Scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 1.4-INT-009 | Integration | P0 | CI builds after quality checks | Pipeline flow | BUS-001 |
| 1.4-INT-010 | Integration | P0 | Build fails on Docker errors | Error propagation | OPS-001 |
| 1.4-INT-011 | Integration | P0 | Buildx cache works across builds | Performance | PERF-001 |
| 1.4-INT-012 | Integration | P1 | Timeout terminates hanging builds | Reliability | OPS-004 |
| 1.4-INT-013 | Integration | P1 | SHA tag applied correctly | Versioning | - |
| 1.4-INT-014 | Integration | P2 | Build logs accessible | Debugging | - |
| 1.4-INT-015 | Integration | P2 | No registry push occurs | Security | OPS-001 |
| 1.4-INT-016 | Integration | P3 | Parallel job execution | Efficiency | - |

#### E2E Test Scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 1.4-E2E-005 | E2E | P0 | Full CI pipeline with Docker build | Critical path | BUS-001 |
| 1.4-E2E-006 | E2E | P0 | Failed tests prevent Docker build | Quality gate | BUS-002 |
| 1.4-E2E-007 | E2E | P1 | PR triggers successful build | Development flow | - |
| 1.4-E2E-008 | E2E | P2 | Build artifacts downloadable | Debugging | - |

## Risk Coverage Matrix

| Risk ID | Test Coverage | Test IDs |
|---------|--------------|----------|
| SEC-001 | High | UNIT-003, INT-001, E2E-001 |
| OPS-001 | High | UNIT-010, UNIT-015, INT-010, INT-015, E2E-005 |
| SEC-002 | Medium | INT-008 |
| PERF-001 | High | UNIT-013, INT-003, INT-005, INT-011 |
| DATA-001 | Medium | UNIT-007, INT-006 |
| TECH-001 | High | UNIT-001, UNIT-006, UNIT-008 |
| SEC-003 | High | UNIT-004, INT-004 |
| PERF-002 | Medium | INT-007 |
| BUS-001 | High | UNIT-011, INT-009, E2E-001, E2E-005 |
| TECH-002 | Medium | UNIT-002, INT-002 |
| OPS-002 | High | UNIT-005, E2E-002 |
| OPS-003 | Medium | E2E-003 |
| OPS-004 | Low | UNIT-012, INT-012 |
| DATA-002 | Low | E2E-004 |

## Test Implementation Details

### Critical P0 Tests - Detailed Specifications

#### 1.4-UNIT-001: Dockerfile Syntax Validation
```python
def test_dockerfile_syntax():
    """Validate Dockerfile has correct syntax"""
    with open("Dockerfile") as f:
        content = f.read()

    # Check for required instructions
    assert "FROM" in content
    assert content.count("FROM") >= 2  # Multi-stage
    assert "COPY" in content
    assert "RUN" in content
    assert "CMD" in content or "ENTRYPOINT" in content

    # Validate no syntax errors
    result = subprocess.run(["docker", "build", "--check", "."])
    assert result.returncode == 0
```

#### 1.4-INT-001: Docker Build Success
```python
def test_docker_build():
    """Test that Docker image builds successfully"""
    result = subprocess.run(
        ["docker", "build", "-t", "test-image:latest", "."],
        capture_output=True
    )
    assert result.returncode == 0
    assert b"Successfully built" in result.stdout

    # Verify image exists
    images = docker_client.images.list("test-image:latest")
    assert len(images) == 1
```

#### 1.4-E2E-001: Container Runtime Test
```python
def test_container_runtime():
    """Test container starts and runs application"""
    container = docker_client.containers.run(
        "test-image:latest",
        detach=True,
        environment={"NATS_URL": "nats://test:4222"}
    )

    try:
        # Wait for startup
        time.sleep(5)

        # Check container is running
        container.reload()
        assert container.status == "running"

        # Check logs for startup message
        logs = container.logs().decode()
        assert "Application started" in logs
        assert "Error" not in logs

    finally:
        container.stop()
        container.remove()
```

### Security Test Specifications

#### 1.4-INT-004: Non-Root User Validation
```python
def test_non_root_user():
    """Verify container runs as non-root user"""
    container = docker_client.containers.run(
        "test-image:latest",
        detach=True,
        command="id -u"
    )

    try:
        result = container.wait()
        uid = container.logs().decode().strip()
        assert uid != "0", "Container should not run as root"

    finally:
        container.remove()
```

#### 1.4-INT-008: Secrets Scanning
```python
def test_no_secrets_in_layers():
    """Ensure no secrets in image layers"""
    # Get image history
    history = docker_client.images.get("test-image:latest").history()

    secret_patterns = [
        r"password\s*=",
        r"api[_-]?key\s*=",
        r"secret\s*=",
        r"token\s*="
    ]

    for layer in history:
        if layer.get("CreatedBy"):
            for pattern in secret_patterns:
                assert not re.search(pattern, layer["CreatedBy"], re.I)
```

## Recommended Execution Order

### Phase 1: Pre-Build Validation (5 min)
1. All P0 Unit tests (syntax, structure, security checks)
2. Dockerfile linting with hadolint

### Phase 2: Build Testing (10 min)
1. P0 Integration tests (build process)
2. P1 Integration tests (optimization)
3. Image size validation

### Phase 3: Runtime Testing (15 min)
1. P0 E2E tests (container startup)
2. P1 E2E tests (health, shutdown)
3. Security runtime tests

### Phase 4: CI Pipeline Testing (10 min)
1. Pipeline configuration tests
2. Build trigger tests
3. Quality gate verification

## Coverage Gaps Analysis

### Identified Gaps
- No performance load testing
- Limited network policy testing
- No multi-architecture build testing
- Missing supply chain security tests

### Recommended Additions
1. Add Trivy/Snyk scanning tests (P0)
2. Add startup performance benchmarks (P2)
3. Add resource limit tests (P2)
4. Add SBOM generation validation (P3)

## Test Data Requirements

### Environment Variables
```yaml
test_env:
  NATS_URL: "nats://test-nats:4222"
  NATS_CLUSTER_ID: "test-cluster"
  NATS_CLIENT_ID: "test-client"
  LOG_LEVEL: "DEBUG"
```

### Mock Services
- NATS server mock for integration tests
- Registry mock for push simulation
- Health endpoint mock responses

## Quality Metrics

### Coverage Targets
- **P0 Tests**: 100% must pass
- **P1 Tests**: 95% must pass
- **P2 Tests**: 80% should pass
- **P3 Tests**: Best effort

### Execution Time Targets
- Unit tests: < 30 seconds
- Integration tests: < 2 minutes
- E2E tests: < 5 minutes
- Total suite: < 10 minutes

## Maintenance Considerations

### Test Stability
- Use specific image tags in tests
- Mock external dependencies
- Implement retry logic for flaky tests
- Clear test isolation

### Documentation
- Each test documents its purpose
- Link tests to requirements
- Maintain test execution guide
- Document known issues

---

**Test Design Complete**
42 comprehensive test scenarios defined with risk alignment
