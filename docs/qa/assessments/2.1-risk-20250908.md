# Risk Profile: Story 2.1 - CTP Gateway Adapter Implementation

Date: 2025-09-08
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks (9): 0
- High Risks (6): 4
- Medium Risks (4): 3
- Low Risks (2-3): 1
- Risk Score: 62/100 (calculated, medium overall; focused high risks around supervision reliability, credential handling, and operational robustness)

## Critical Risks Requiring Immediate Attention

### 1. OPS-001: Unbounded or incorrect retry behavior causing instability

Score: 6 (High)
Probability: Medium — Retry loops are error prone without clear caps
Impact: High — Can cause hot-loop storms, resource exhaustion, noisy logs

Mitigation:
- Enforce max_retries=3 with tests (2.1-UNIT-005, 2.1-INT-003)
- Verify backoff sequence ~= [0.5,1.0,2.0] and no further attempts (2.1-UNIT-004)
- Ensure shutdown event breaks supervision loop (2.1-INT-002)

### 2. SEC-001: Credential exposure via logs or unsafe mapping helpers

Score: 6 (High)
Probability: Medium — Logging fields may accidentally capture secrets
Impact: High — Secret leakage (broker/user/password/auth_code)

Mitigation:
- Mask secrets in any to_dict_safe() or log contexts (2.1-UNIT-009)
- Validate mapping uses only necessary fields and never logs raw settings

### 3. TECH-002: Thread lifecycle deadlock or orphaned threads

Score: 6 (High)
Probability: Medium — Thread joins can deadlock if worker blocks
Impact: High — Service hangs on shutdown, resource leaks

Mitigation:
- Require disconnect() to set shutdown flag and join with bounded wait (2.1-INT-001)
- Structure worker to periodically check shutdown signal

### 4. BUS-001: Failure to reconnect leads to prolonged market data outage

Score: 6 (High)
Probability: Medium — Transient failures common in gateways
Impact: High — Lost data feed, operational downtime

Mitigation:
- Implement supervised restart with verified backoff (2.1-UNIT-004, -005)
- Emit structured logs to aid operators in diagnosing failures (2.1-UNIT-006)

## Risk Distribution

### By Category

- Technical: 3 (1 high, 2 medium)
- Security: 1 (1 high)
- Performance: 1 (1 medium)
- Data: 1 (1 medium)
- Business: 1 (1 high)
- Operational: 1 (1 high)

### By Component

- Adapter threading/supervision: 4
- Config and mapping: 2
- Logging/observability: 1
- Endpoint normalization: 1

## Detailed Risk Register

| ID        | Category   | Title                                                   | Prob. | Impact | Score | Priority |
| --------- | ---------- | ------------------------------------------------------- | ----- | ------ | ----- | -------- |
| OPS-001   | operational| Unbounded/incorrect retry behavior                      | Med   | High   | 6     | High     |
| SEC-001   | security   | Credential exposure in logs or mapping                  | Med   | High   | 6     | High     |
| TECH-002  | technical  | Thread deadlock/orphan on shutdown                      | Med   | High   | 6     | High     |
| BUS-001   | business   | Reconnect failure → market data outage                  | Med   | High   | 6     | High     |
| PERF-001  | performance| Log flood during retry/backoff                          | Med   | Med    | 4     | Medium   |
| DATA-001  | data       | Incorrect address normalization                          | Med   | Med    | 4     | Medium   |
| TECH-001  | technical  | Interface mismatch with MarketDataPort                   | Low   | Med    | 3     | Low      |
| TECH-003  | technical  | Backoff timing drift causes flaky tests                  | Low   | Med    | 3     | Low      |

## Risk-Based Testing Strategy

Priority 1 (High score risks):
- OPS-001, BUS-001 — Tests 2.1-UNIT-004/-005, 2.1-INT-003 verify capped retries and correct backoff sequence
- TECH-002 — Tests 2.1-INT-001/-002 validate clean shutdown and worker cooperation
- SEC-001 — Test 2.1-UNIT-009 verifies masking of sensitive values

Priority 2 (Medium score risks):
- PERF-001 — Test 2.1-UNIT-006 verifies structured logging; consider rate limiting if needed
- DATA-001 — Test 2.1-UNIT-008 validates normalization rules including ssl://

Priority 3 (Low score risks):
- TECH-001/TECH-003 — Contract and timing tolerances; keep time-based assertions within tolerance

## Gate YAML Block (risk_summary)

```yaml
risk_summary:
  totals:
    critical: 0
    high: 4
    medium: 3
    low: 1
  highest:
    id: OPS-001
    score: 6
    title: 'Unbounded/incorrect retry behavior'
  recommendations:
    must_fix:
      - 'Enforce max_retries=3 and verify with tests'
      - 'Validate backoff ~= [0.5,1.0,2.0] with tolerance'
      - 'Ensure disconnect() signals and joins worker reliably'
      - 'Mask all credentials in logs and safe dicts'
    monitor:
      - 'Watch retry log volume; add rate limiting if noisy'
      - 'Alert on repeated gateway failures to enable operator response'
```

## Annotations

- Mitigated by tests: 2.1-UNIT-004/-005/-006/-007/-008/-009, 2.1-INT-001/-002/-003
- Logging: Use JSON logger fields {attempt, reason, next_backoff}; never log secrets
- Time-based assertions: Use tolerances to avoid flaky behavior
