# Environment Consistency Implementation Guide

## 1. Docker Setup (Recommended Approach)

### Dockerfile for Development
```dockerfile
# Dockerfile.dev
FROM python:3.13-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install uv
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.cargo/bin:${PATH}"

WORKDIR /app

# Copy dependency files first (cache optimization)
COPY pyproject.toml uv.lock* ./

# Install dependencies
RUN uv sync --frozen

# Copy source code
COPY . .

# Development command
CMD ["uv", "run", "python", "-m", "src"]
```

### Docker Compose for Consistency
```yaml
# docker-compose.yml
version: '3.8'

services:
  dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      - .:/app
      - uv-cache:/root/.cache/uv
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    stdin_open: true
    tty: true
    command: /bin/bash

volumes:
  uv-cache:
```

### Platform-Specific Setup Scripts

#### setup.sh (Unix-like)
```bash
#!/bin/bash
set -e

echo "üîç Detecting environment..."

# Detect OS
OS=$(uname -s)
ARCH=$(uname -m)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

echo "üì¶ Setting up development environment for $OS/$ARCH"

# Check Python version
PYTHON_VERSION=$(python3 --version 2>&1 | grep -Po '(?<=Python )\d+\.\d+')
REQUIRED_VERSION="3.13"

if [ "$PYTHON_VERSION" != "$REQUIRED_VERSION" ]; then
    echo -e "${RED}‚ùå Python $REQUIRED_VERSION required, found $PYTHON_VERSION${NC}"
    exit 1
fi

# Install uv if not present
if ! command -v uv &> /dev/null; then
    echo "üì• Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    export PATH="$HOME/.cargo/bin:$PATH"
fi

# Platform-specific configurations
case "$OS" in
    Darwin)
        echo "üçé Configuring for macOS..."
        # Add macOS specific setup
        ;;
    Linux)
        echo "üêß Configuring for Linux..."
        # Add Linux specific setup
        ;;
esac

# Create project structure
echo "üìÅ Creating project structure..."
mkdir -p src/{adapters,domain,application}
mkdir -p tests/{unit,integration}

# Install dependencies
echo "üìö Installing dependencies..."
uv sync

# Run validation
echo "‚úÖ Running environment validation..."
python3 scripts/validate_environment.py

echo -e "${GREEN}‚ú® Environment setup complete!${NC}"
```

#### setup.ps1 (Windows PowerShell)
```powershell
# setup.ps1
$ErrorActionPreference = "Stop"

Write-Host "üîç Detecting environment..." -ForegroundColor Blue

# Check Python version
$pythonVersion = python --version 2>&1
if ($pythonVersion -notmatch "3\.13") {
    Write-Host "‚ùå Python 3.13 required" -ForegroundColor Red
    exit 1
}

# Install uv
if (!(Get-Command uv -ErrorAction SilentlyContinue)) {
    Write-Host "üì• Installing uv..." -ForegroundColor Yellow
    irm https://astral.sh/uv/install.ps1 | iex
}

# Configure Git for Windows
git config core.autocrlf true

# Create structure
Write-Host "üìÅ Creating project structure..." -ForegroundColor Yellow
New-Item -ItemType Directory -Force -Path "src\adapters"
New-Item -ItemType Directory -Force -Path "src\domain"
New-Item -ItemType Directory -Force -Path "src\application"
New-Item -ItemType Directory -Force -Path "tests\unit"
New-Item -ItemType Directory -Force -Path "tests\integration"

# Install dependencies
Write-Host "üìö Installing dependencies..." -ForegroundColor Yellow
uv sync

# Validate
Write-Host "‚úÖ Running validation..." -ForegroundColor Green
python scripts\validate_environment.py

Write-Host "‚ú® Setup complete!" -ForegroundColor Green
```

### Environment Validation Script
```python
# scripts/validate_environment.py
import sys
import subprocess
import importlib
from pathlib import Path

def check_python_version():
    """Verify Python 3.13"""
    version = sys.version_info
    assert version.major == 3 and version.minor == 13, f"Python 3.13 required, got {version.major}.{version.minor}"
    print("‚úì Python 3.13 verified")

def check_uv():
    """Verify uv is installed and working"""
    result = subprocess.run(["uv", "--version"], capture_output=True, text=True)
    assert result.returncode == 0, "uv not found or not working"
    print(f"‚úì uv installed: {result.stdout.strip()}")

def check_project_structure():
    """Verify hexagonal architecture structure"""
    required_dirs = [
        "src/adapters",
        "src/domain",
        "src/application",
        "tests/unit",
        "tests/integration"
    ]

    for dir_path in required_dirs:
        assert Path(dir_path).exists(), f"Missing directory: {dir_path}"

    print("‚úì Project structure verified")

def check_tools():
    """Verify development tools"""
    tools = {
        "black": "black --version",
        "mypy": "mypy --version"
    }

    for tool, cmd in tools.items():
        result = subprocess.run(cmd.split(), capture_output=True, text=True)
        assert result.returncode == 0, f"{tool} not working"
        print(f"‚úì {tool} verified")

def main():
    print("\nüîç Validating Development Environment\n")

    checks = [
        check_python_version,
        check_uv,
        check_project_structure,
        check_tools
    ]

    for check in checks:
        try:
            check()
        except AssertionError as e:
            print(f"‚ùå {e}")
            sys.exit(1)

    print("\n‚úÖ All checks passed! Environment is ready.\n")

if __name__ == "__main__":
    main()
```

## 2. Cross-Platform CI Validation

### GitHub Actions Workflow
```yaml
# .github/workflows/environment-validation.yml
name: Environment Validation

on: [push, pull_request]

jobs:
  test-matrix:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.13"]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
        shell: bash

      - name: Run setup script
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./setup.ps1
          else
            ./setup.sh
          fi
        shell: bash

      - name: Validate environment
        run: python scripts/validate_environment.py
```

---
*Environment Consistency Guide - Story 1.1*
*Generated by Quinn (Test Architect)*
