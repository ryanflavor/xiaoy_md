# Story 3.7: Ops Console & Compose Runtime Integration
**故事 3.7：运维控制台与 Compose 运行时联通**

## Status
Draft

## Story
**As an** Operations Engineer,
**I want** the Story 3.6 console to orchestrate and observe the Docker Compose live stack via the operations API,
**so that** I can execute runbooks and verify telemetry without leaving the UI.

## Acceptance Criteria
1. Console-triggered runbook actions invoke `/api/ops/runbooks/execute` against the live `docker compose --profile live` environment, execute `start_live_env.sh`, and surface structured logs plus updated `md_runbook_exit_code`/`md_failover_latency_ms` metrics in the UI.
2. The operations API runs as the `ops-api` service inside Docker Compose, listening on `0.0.0.0:9180` (exported to the host on port `9180`), protected by Bearer tokens, and the console reads `VITE_OPS_API_BASE_URL`/`VITE_OPS_API_TOKEN` (or equivalent) from configuration so operators can securely connect without code changes.
3. Metrics and status panels consume the live Prometheus base URL (`prometheus:9090`) and health snapshots emitted by `check_feed_health.py`, keeping Overview/Subscription Health pages in sync with Compose services.
4. End-to-end tests (mock profile acceptable) and updated runbook documentation prove the UI → API → Compose flow, covering success/failure drills and degraded-mode guidance.
5. Product documentation (PRD Epic 3 story list and Sprint Change Proposal) is updated to reflect the new Story 3.7 scope and to defer the SOPT integration to a future story identifier.

## Tasks / Subtasks
- [ ] Align product scope and Compose topology for the new operations API (AC: 2, 5)
  - [ ] Update PRD Epic 3 documentation and the sprint change proposal to redefine Story 3.7 as ops-console runtime integration, preserving the former SOPT integration item as a future story ID. [Source: docs/prd/epics-史诗.md#epic-3-production-operations--multi-source-expansion]
  - [ ] Extend `docker-compose.yml` with an `ops-api` service exposing `uvicorn src.infrastructure.http.ops_api:app --host 0.0.0.0 --port 9180`, bind-mounting `logs/runbooks/` and `scripts/operations/`, and wiring required environment variables. [Source: docs/architecture/infrastructure-and-deployment.md#operational-automation--runbooks]
  - [ ] Document the default host/port (`http://localhost:9180`) for operators and note any reverse-proxy integration in the deployment guide. [Source: docs/architecture/infrastructure-and-deployment.md#deployment-strategy]
- [ ] Expose an operations API runtime that can drive Compose orchestration (AC: 1, 2)
  - [ ] Provide a reusable entrypoint (e.g., `uvicorn` CLI or supervisor script) for `src.infrastructure.http.ops_api:app`, ensuring shared logs directory access and default `OPS_API_TOKENS`/`OPS_PROMETHEUS_URL` wiring. [Source: docs/architecture/rest-api-spec.md#operations-console-api]
  - [ ] Ensure the runtime executes `scripts/operations/start_live_env.sh` / `docker compose --profile live ...` with preserved structured output, Asia/Shanghai timestamps, and non-root safety. [Source: docs/architecture/core-workflows.md#workflow-live-environment-orchestration]
  - [ ] Mount or document required volumes (`logs/`, `scripts/operations/`, optional `.env` secrets) so runbook artifacts persist for UI retrieval. [Source: docs/architecture/source-tree.md#10-source-tree]
- [ ] Wire the operations console UI to the hosted API endpoint (AC: 1, 2)
  - [ ] Inject `VITE_OPS_API_BASE_URL` and token secrets through `.env` / deployment config and update the UI data layer to consume them. [Source: docs/ops/operations-console-spec.md#data-integration-数据集成]
  - [ ] Add local dev tooling (proxy configuration or Vite middleware) so `npm run dev` can talk to `http://localhost:9180` without CORS drift, respecting the React + Vite + TanStack Query stack. [Source: docs/architecture/tech-stack.md#technology-stack-table]
  - [ ] Surface bilingual error states when the API is unreachable or unauthorized, and refresh Overview/Drill Control/Audit Timeline components after command completion to display latest logs, metrics, and history. [Source: docs/ops/operations-console-spec.md#7-error-handling-失败与降级]
- [ ] Synchronize telemetry and health data between Compose and the console (AC: 1, 3)
  - [ ] Configure the API to proxy Prometheus range/snapshot queries (`/api/ops/metrics/*`) against the Compose Prometheus endpoint and normalize timestamps to Asia/Shanghai. [Source: docs/architecture/observability-and-ops.md#operations-console-integration]
  - [ ] Persist `ops_console_status.json` and health artifacts in shared storage so `GET /api/ops/status` reflects runbook history and health checks. [Source: docs/ops/production-runbook.md#8-operations-console-usage-控制台操作指南]
  - [ ] Ensure health-check executions (`check_feed_health.py`) invoked via the API publish coverage metrics that align with Subscription Health tables. [Source: docs/architecture/observability-and-ops.md#telemetry-architecture]
- [ ] Validate end-to-end flow and document operator guidance (AC: 4)
  - [ ] Extend Playwright/Vitest/pytest suites (e.g., `pytest tests/integration/test_ops_api.py`, `npm run test`, `npm run test:e2e`) to exercise mock-profile runbook execution and assert UI updates (status banner, audit timeline). [Source: docs/architecture/test-strategy-and-standards.md#testing-philosophy]
  - [ ] Update `docs/ops/production-runbook.md` console usage section with bootstrap instructions, auth tokens, and fallback steps when the API is down. [Source: docs/ops/production-runbook.md#8-operations-console-usage-控制台操作指南]
  - [ ] Document degraded-mode expectations (metrics or API offline) consistent with console error handling guidance. [Source: docs/ops/operations-console-spec.md#7-error-handling-失败与降级]

## Dev Notes
- Operations console endpoints require Bearer tokens and must return runbook history, health snapshots, and Prometheus-backed metrics for UI consumption. [Source: docs/architecture/rest-api-spec.md#operations-console-api]
- Live orchestration relies on `start_live_env.sh` managing the `docker compose --profile live` stack, emitting structured logs and Pushgateway metrics for drill verification. [Source: docs/architecture/core-workflows.md#workflow-live-environment-orchestration]
- Observability integration mandates querying Prometheus (`prometheus:9090`) and merging Pushgateway samples so the console reflects failover latency, runbook exit codes, and coverage ratios. [Source: docs/architecture/observability-and-ops.md#operations-console-integration]
- Deployment guidance defines how the console build injects `VITE_OPS_API_BASE_URL` / `VITE_OPS_API_TOKEN` and promotes artifacts alongside backend services. [Source: docs/architecture/infrastructure-and-deployment.md#deployment-strategy]
- Audit logging rules require Asia/Shanghai timestamps, masked account identifiers, and structured JSON logs for all automation calls. [Source: docs/architecture/security.md#audit-logging]

## Testing
- `pytest tests/integration/test_ops_api.py` (mock profile) verifies API authentication, runbook execution payloads, and Prometheus proxy behavior (AC: 1, 3, 4).
- `npm run test` (Vitest + React Testing Library) covers TanStack Query hooks, error states, and UI refreshes when runbook history updates (AC: 1, 2).
- `npm run test:e2e -- --config ui/operations-console/tests/playwright.config.ts --project=mock` exercises UI → API workflows, confirmation dialogs, and degraded-mode banners (AC: 2, 4).
- `docker compose --profile live up -d ops-api` followed by `curl -sf http://localhost:9180/api/ops/status` validates the Compose deployment and documented port mapping (AC: 2).

## Project Structure Notes
- Follow the documented repository layout (`ui/operations-console/` for React client, `src/infrastructure/http/ops_api.py` for API, `scripts/operations/` for runbooks, `logs/runbooks/` for artifacts). [Source: docs/architecture/source-tree.md#10-source-tree]

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
_Pending after implementation_

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-23 | 0.1 | Draft story created | Bob (Scrum Master) |
