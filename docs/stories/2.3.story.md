# Story 2.3: NATS Publisher Adapter Implementation

## Status
Done

## Story
**As a** Developer,
**I want** to implement the NATS Publisher Adapter that consumes from the internal queue,
**so that** the service can publish the received market data onto the NATS cluster.

## Acceptance Criteria
1. NATSPublisher implements the domain output port (`MessagePublisherPort`) and integrates with `MarketDataService` lifecycle (connect/disconnect/health).
2. Core service passes validated ticks to the publisher via `MessagePublisherPort.publish(topic, data)`; integration verified end-to-end in unit tests.
3. Serialization uses JSON today; configuration key is defined for future optional Pickle strategy (default JSON). Serialization errors are isolated (poison-pill handling) and do not crash processing.
4. Publish uses retry with exponential backoff; failures are logged with structured JSON. Tests verify publish call with expected subject and payload and exercise retry path.
5. Subject naming scheme is documented in this story and used consistently in code/config (see Dev Notes → Subject Naming): `market.tick.{exchange}.{symbol}`.
6. Timezone policy: serialized timestamps include `+08:00` (Asia/Shanghai) per coding standards; if upstream provides UTC, convert at the adapter boundary.
7. Payload includes `exchange` field in addition to existing fields.

## Tasks / Subtasks
- [x] Verify/enhance NATSPublisher implementation (AC: 1, 3, 4, 6)
  - [x] Confirm `src/infrastructure/nats_publisher.py` implements `MessagePublisherPort` and lifecycle methods align with app expectations [Source: architecture/source-tree.md]
  - [x] Ensure retry with exponential backoff and circuit breaker are configured and logged (structured JSON) [Source: architecture/error-handling-strategy.md]
  - [x] Ensure health responder subscribes on `settings.nats_health_check_subject` and returns status JSON [Source: architecture/components.md]

- [x] Implement/confirm publish serialization (AC: 3, 7)
  - [x] JSON path implemented: payload contains symbol, price, volume, timestamp, bid, ask from domain model [Source: architecture/data-models.md#tickdatamodel-pydantic]
  - [x] Add `exchange` field to payload (derived as described below)
  - [x] Define config key for optional Pickle strategy (future), default JSON; document in Dev Notes [Source: architecture/tech-stack.md]
  - [x] Wrap serialization in try/except to isolate poison pills and continue [Source: architecture/error-handling-strategy.md]

- [x] Publish to NATS subject (AC: 4, 5, 7)
  - [x] Publish using NATS client with retry/backoff on failure [Source: architecture/core-workflows.md; architecture/error-handling-strategy.md]
  - [x] Update `MarketDataService` topic composition to `market.tick.{exchange}.{symbol}` and update tests/config accordingly [Source: Dev Notes → Subject Naming]
  - [x] Log structured JSON for failures and retries (no print) [Source: architecture/coding-standards.md]

- [x] Wire adapter to core service (AC: 2)
  - [x] Ensure `MarketDataService` uses the `MessagePublisherPort` for publishing; no infra imports in domain/app [Source: architecture/components.md]

- [x] Unit tests for adapter behavior (AC: 2, 3, 4, 5)
  - [x] `tests/unit/test_nats_publisher_unit.py` with NATS client mocked
  - [x] Test: successful publish calls client with expected subject and payload (including `exchange`)
  - [x] Test: serialization error path is logged and does not crash the loop
  - [x] Test: retry/backoff occurs on publish failure; circuit resumes on success
  - [x] Test: subject naming scheme `market.tick.{exchange}.{symbol}` is applied consistently
  - [x] Follow AAA and link tests to ACs in comments [Source: architecture/test-strategy-and-standards.md]

- [x] Project structure alignment
  - [x] Verify paths match `docs/architecture/source-tree.md` and update if needed [Source: architecture/source-tree.md]

## Dev Agent Record

### Agent Model Used
OpenAI o3 (2025-09)

### Debug Log References
- .ai/debug-log.md

### Completion Notes List
- Implemented subject scheme `market.tick.{exchange}.{symbol}` in `MarketDataService`.
- Added `exchange` to publish payload and enforced Asia/Shanghai timezone in serialization.
- Updated existing unit test to new subject format; added focused unit tests for subject/payload and NATSPublisher publish behavior.
- Confirmed NATSPublisher lifecycle, retry/backoff, and health responder are in place.
- Added `AppSettings.serialization_strategy` (default 'json') to prepare for optional Pickle path.

### File List
- Modified: src/application/services.py
- Modified: tests/unit/test_market_data_service_flow.py
- Added: tests/unit/test_market_data_subject_and_payload.py
- Added: tests/unit/test_nats_publisher_unit.py
- Modified: src/config.py

## Dev Notes

### Dependencies
- Depends on Story 2.1 (CTP Gateway Adapter) and Story 2.2 (Sync-to-Async Event Bridge) being Done.

### Previous Story Insights
- Story 2.2 implemented the bridge from vnpy synchronous ticks into the async loop using a bounded `asyncio.Queue` with drop-and-log backpressure handling. The publisher adapter will consume validated ticks from the core loop and publish them to NATS. [Source: docs/stories/2.2.story.md]

### Architecture Context

#### Component Interaction Flow
[Source: architecture/core-workflows.md#workflow-processing-a-market-tick]
1. CTP Adapter translates external Tick to DomainTick
2. Core Service validates the DomainTick
3. Core calls the Publisher output port to publish
4. NATS Adapter serializes (JSON/Pickle) and publishes to NATS

#### Output Port Contract
[Source: architecture/components.md#ports-interface-definitions]
- EventPublisherPort (aka message publisher) exposes a method to publish a domain tick/event. The NATS adapter implements this port for the infrastructure layer.

#### Data Model
[Source: architecture/data-models.md#tickdatamodel-pydantic]
- Domain tick model fields include: symbol, price, volume, timestamp, bid, ask.
- Data is validated and normalized before publication.

#### File Locations
[Source: architecture/source-tree.md]
- Adapter implementation: `src/infrastructure/nats_publisher.py`
- Domain ports: `src/domain/ports.py`
- Unit tests: `tests/unit/test_nats_publisher.py`

#### Technical Constraints
[Source: architecture/tech-stack.md#technology-stack-table]
- Python 3.13 with asyncio; message bus is NATS/JetStream.
[Source: architecture/coding-standards.md#critical-rules]
- Strict Hexagonal Architecture: app/domain cannot import infrastructure.
- DTOs/domain models are Pydantic and domain objects treated as immutable.
- Structured JSON logging only; no `print()`.
- Timezone policy: timestamps produced/serialized carry Asia/Shanghai (`+08:00`) where applicable in infrastructure outputs.

#### Error Handling & Resilience
[Source: architecture/error-handling-strategy.md#nats-publish-failures]
- Use exponential backoff retry policy for NATS publish failures.
[Source: architecture/error-handling-strategy.md#poison-pill-messages]
- Wrap serialization in try/except to quarantine bad messages and continue.

#### Serialization
[Source: architecture/core-workflows.md#workflow-processing-a-market-tick; architecture/tech-stack.md#technology-stack-table]
- Implemented: JSON serialization (current). Define a configuration key for future optional Pickle strategy; default remains JSON. Clearly log the active serialization strategy at startup.

#### Subject Naming
 - Selected scheme: `market.tick.{exchange}.{symbol}`
   - Example: `market.tick.CFFEX.IF2312`

### Exchange Derivation
- For vnpy `vt_symbol` style symbols (`SYMBOL.EXCHANGE`), derive:
  - `exchange` = substring after the last `.` (e.g., `IF2312.CFFEX` → `CFFEX`)
  - `symbol` for subject payload can remain full vt_symbol in data, but subject uses the split parts as above
- If no `.` present, set `exchange` to `UNKNOWN` (configurable later) and keep `symbol` unchanged
- Include derived `exchange` in the payload as a top-level field

### Configuration
List required settings and where they are set (`src/config.py` → `AppSettings`).
- `NATS_URL` → `settings.nats_url`
- `NATS_CLUSTER_ID` → `settings.nats_cluster_id`
- `NATS_CLIENT_ID` → `settings.nats_client_id`
- `NATS_USER` → `settings.nats_user` (optional)
- `NATS_PASSWORD` → `settings.nats_password` (optional)
- `NATS_HEALTH_CHECK_SUBJECT` → `settings.nats_health_check_subject`
- `SERIALIZATION_STRATEGY` (planned) → default `json`, optional `pickle` in future

### Testing Standards
[Source: architecture/test-strategy-and-standards.md]
- Use pytest; follow AAA; avoid trivial tests.
- Tests must validate behavior tied to ACs and verify interactions with mocks.
- Place tests under `tests/unit/` following naming conventions.

### Project Structure Notes
[Source: architecture/source-tree.md]
- Ensure new files align with the defined source tree.
- Keep the adapter in infrastructure layer and interact only via the `MessagePublisherPort`.

## QA Results

_Pending after implementation_

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-10 | 0.1 | Initial story draft created | Bob (Scrum Master) |
### Timezone Policy Harmonization
- Coding standards require Asia/Shanghai (`+08:00`) for infrastructure outputs. Ensure serialized timestamps include `+08:00` offset. If upstream domain ticks arrive in UTC (as noted in 2.2), convert to Asia/Shanghai in the publisher before serialization, or update upstream story to align; document decision here and in tests.
