# Story 3.4: Subscription Health Checks & Recovery
**故事 3.4：订阅健康检查与恢复机制**

## Status
Ready for Review

## Story
**As a** Market Data SRE,
**I want** automated checks that compare actual subscriptions against the expected contract universe,
**so that** missing instruments or stalled feeds are remediated quickly.

## Acceptance Criteria
1. `scripts/operations/check_feed_health.py` lists missing or stalled contracts with exit codes for CI/automation.
2. Health reports can run in read-only mode without disrupting live traffic.
3. Runbook or automation triggers resubscription or operator escalation when anomalies persist.

## Tasks / Subtasks
- [x] Build subscription health agent tooling (AC: 1, 2) [Source: docs/architecture/core-workflows.md#workflow-subscription-health-check--recovery]
  - [x] Implement `scripts/operations/check_feed_health.py` CLI with `--mode {dry-run,enforce,audit}`, contract catalogue input, and optional JSON/CSV output for audit trails. [Source: docs/ops/subscription-check.md#1-script-overview-脚本概览]
  - [x] Fetch the expected contract universe via control plane (`md.contracts.list`) or catalogue file and compare with the active subscription set supplied by the service/repository, computing coverage ratio and identifying stalled streams. [Source: docs/architecture/components.md#subscription-health-agent]
  - [x] Emit structured stdout plus `logs/runbooks/subscription_check_*.log` entries using JSON logging, returning exit codes (0=pass, 1=warnings, ≥2=errors) aligned with runbook automation. [Source: docs/ops/subscription-check.md#4-output-interpretation-输出解读]
  - [x] Push health metrics (`md_subscription_coverage_ratio` and related labels) to Prometheus/Pushgateway so dashboards and alerts can ingest them. [Source: docs/architecture/observability-and-ops.md#metric-catalog]
- [x] Deliver remediation workflows and integrations (AC: 2, 3) [Source: docs/architecture/core-workflows.md#workflow-subscription-health-check--recovery]
  - [x] Ensure `--mode dry-run` performs read-only checks that never resubscribe or mutate state, satisfying the non-disruptive requirement. [Source: docs/prd/epics-史诗.md#story-34-subscription-health-checks--recovery]
  - [x] In `--mode enforce`, call into `scripts/operations/full_feed_subscription.py` (or equivalent control-plane helper) to resubscribe missing/stalled contracts, respecting rate-limit knobs from AppSettings. [Source: docs/stories/2.5.story.md#dev-notes]
  - [x] Implement escalation hooks (e.g., Slack/PagerDuty payloads or structured log markers) when issues persist beyond configured retries, surfacing next actions defined in the runbook checklist. [Source: docs/ops/production-runbook.md#5-routine-health-checks-日常健康巡检]
- [x] Update documentation and configuration assets (AC: 1, 2, 3) [Source: docs/ops/subscription-check.md]
  - [x] Refresh `docs/ops/subscription-check.md` with finalized CLI flags, exit codes, remediation flow, and audit guidance; bump the version and align examples. [Source: docs/ops/subscription-check.md#6-audit--reporting-审计与报告]
  - [x] Extend `docs/ops/production-runbook.md` with hourly checklist steps, escalation criteria, and links to Grafana alerting for coverage gaps. [Source: docs/ops/production-runbook.md#5-routine-health-checks-日常健康巡检]
  - [x] Document configuration expectations (contract catalogue storage, Pushgateway URL, notification wiring) in `docs/architecture/observability-and-ops.md` or related architecture sections for traceability. [Source: docs/architecture/observability-and-ops.md#dependencies--configuration]
- [x] Add automated validation and regression coverage (AC: 1, 2, 3) [Source: docs/architecture/test-strategy-and-standards.md#testing-philosophy]
  - [x] Create pytest coverage for coverage-ratio calculations, stalled feed detection, exit code mapping, and dry-run vs enforce behaviors using fixtures/mocks under `tests/unit/operations/`. [Source: docs/architecture/source-tree.md#10-source-tree]
  - [x] Add tests or integration stubs confirming resubscribe flows invoke the control plane helpers with rate-limit compliance and that coverage metrics payloads contain expected labels/values. [Source: docs/architecture/observability-and-ops.md#metric-catalog]
  - [x] Wire the script into CI/local automation (e.g., `scripts/ci-local.sh`) so health validation can run in mock mode without requiring live credentials, guarding against regressions. [Source: docs/ops/subscription-check.md#7-checklist-巡检检查清单]

## Dev Notes

### Previous Story Insights
- Story 3.1 established orchestration expectations for starting subscription workers, so the health script must coordinate with `start_live_env.sh` outputs and logs. [Source: docs/stories/3.1.story.md#component-specifications]
- Story 3.2 documented `.env` governance including Pushgateway endpoints and rate-limit knobs, which the health tooling should reuse rather than introducing new variable names. [Source: docs/stories/3.2.story.md#technical-constraints]
- Story 3.3 adds dashboards and alerts that depend on `md_subscription_coverage_ratio` metrics, making this script the producer of those series. [Source: docs/stories/3.3.story.md#tasks--subtasks]
- Story 2.5’s bulk subscription workflow provides the control plane hooks (`md.contracts.list`, `md.subscribe.bulk`) and audit logging that the remediation path should invoke. [Source: docs/stories/2.5.story.md#dev-notes]

### Data Models
- Health calculations revolve around the contract catalogue exposed via `md.contracts.list` and the active subscription records tracked by `MarketDataService`. [Source: docs/architecture/core-workflows.md#workflow-subscription-health-check--recovery]
- Metrics emitted must follow the naming and label schema in the Telemetry Architecture table (`md_subscription_coverage_ratio`, `md_rate_limit_hits`). [Source: docs/architecture/observability-and-ops.md#metric-catalog]

### API Specifications
- Leverage the existing NATS control plane subjects (`md.contracts.list`, `md.subscribe.bulk`) and add a lightweight status query if needed to retrieve active subscriptions, returning JSON suitable for health analysis. [Source: docs/architecture/components.md#subscription-health-agent]

### Component Specifications
- The Subscription Health Agent component is responsible for scheduled checks, metrics emission, and remediation triggers; implementation must align with that orchestration. [Source: docs/architecture/components.md#subscription-health-agent]
- Runbook integration requires annotated logs in Asia/Shanghai timezone and structured fields for auditability. [Source: docs/architecture/security.md#audit-logging]

### File Locations
- Place CLI code under `scripts/operations/` and supporting modules/tests under `src/operations/` and `tests/unit/operations/` respectively to match the defined source tree. [Source: docs/architecture/source-tree.md#10-source-tree]
- Store reference catalogues or configuration samples under `config/contracts/` if needed, keeping sensitive data out of version control. [Source: docs/ops/subscription-check.md#2-required-inputs-输入前置条件]

### Testing Requirements
- Use pytest to cover CLI parsing, exit codes, remediation branching, and metrics emission, ensuring tests remain deterministic with mocked NATS/control-plane interactions. [Source: docs/architecture/test-strategy-and-standards.md#testing-philosophy]
- Provide smoke tests that simulate Pushgateway submissions and confirm audit artifacts land in `logs/runbooks/`. [Source: docs/ops/production-runbook.md#1-pre-market-startup-盘前启动]

### Technical Constraints
- Follow JSON logging conventions and Asia/Shanghai timezone standards while avoiding bare `print()`. [Source: docs/architecture/coding-standards.md#critical-rules]
- Do not store real credentials or contract data in the repository; rely on `.env`/Vault workflows defined earlier. [Source: docs/architecture/security.md#secrets-management]
- Ensure automation respects rate-limit settings and does not trigger excessive control plane traffic during health runs. [Source: docs/architecture/infrastructure-and-deployment.md#configuration--secrets-governance]

## Project Structure Notes
- Keep operational automation in `scripts/operations/`, documentation under `docs/ops/`, configuration specimens in `config/`, and supporting library code/tests in `src/` / `tests/` to stay aligned with the architecture source tree. [Source: docs/architecture/source-tree.md#10-source-tree]

## Dev Agent Record

### Agent Model Used
GPT-5 Codex

### Debug Log References
- logs/runbooks/subscription_check_ci_*.log
- logs/runbooks/mock/test_health_*.log
- CLI stdout events `health_check_start`, `remediation_result`, `health_check_complete`

### Completion Notes List
- Added control-plane snapshot endpoint (`md.subscriptions.active`) plus subscription activity tracking in `MarketDataService` for accurate stall detection.
- Implemented health-check CLI/core module with JSON logging, Pushgateway metrics, configurable remediation retries, escalation markers/commands, and offline-friendly inputs.
- Wired hourly automation into `scripts/ci-local.sh`, delivered pytest coverage for evaluation/remediation logic, and provided reusable fixtures.
- Updated subscription health runbook, procedure, and observability docs to reflect new flags, metrics, and escalation guidance.

### File List
- src/application/services.py
- src/infrastructure/rpc_nats.py
- src/operations/check_feed_health.py
- src/operations/__init__.py
- scripts/operations/check_feed_health.py
- scripts/ci-local.sh
- tests/unit/operations/test_check_feed_health.py
- tests/fixtures/subscription_health/contracts.json
- tests/fixtures/subscription_health/active_snapshot.json
- docs/ops/subscription-check.md
- docs/ops/production-runbook.md
- docs/architecture/observability-and-ops.md
- docs/architecture/core-workflows.md
- docs/architecture/components.md

## QA Results

### Review Date: 2025-09-23

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Remediation now sends a single `md.subscribe.bulk` request per attempt (`src/operations/check_feed_health.py:560`), keeping control-plane load predictable and allowing `remediation.succeeded` to reflect the true post-run state. Escalation markers remain in place and fire only when retries are exhausted.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ✓ Structure/logging remain consistent with operations package.
- Project Structure: ✓ Feature and docs landed in expected locations.
- Testing Strategy: ✓ `uv run pytest tests/unit/operations/test_check_feed_health.py -q --no-cov` passes; dry-run CLI invocation also succeeds.
- All ACs Met: ✓ Health script retries, emits escalation markers, and honours remediation success semantics.

### Improvements Checklist
- [x] Confirmed single-remediation RPC per attempt with fresh coverage (`src/operations/check_feed_health.py:560`, `tests/unit/operations/test_check_feed_health.py:284`).
- [x] Regression test keeps escalation vs. success semantics intact across retries (`tests/unit/operations/test_check_feed_health.py:168`).

### Security Review
- No new secret handling; escalation command remains opt-in and escaped via formatting (`src/operations/check_feed_health.py:689-718`).

### Performance Considerations
- Single-call remediation prevents redundant control-plane traffic while still respecting rate limits.

### Files Modified During Review
- None.

### Gate Status
Gate: PASS → docs/qa/gates/3.4-subscription-health-checks-recovery.yml
Risk profile: not generated (not requested)
NFR assessment: not generated (not requested)

### Recommended Status
[✓ Ready for Done]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 0.1 | Draft story created | Bob (Scrum Master) |
| 2025-09-23 | 1.0 | Subscription health automation, remediation tooling, docs, and tests | James (Dev Agent) |
