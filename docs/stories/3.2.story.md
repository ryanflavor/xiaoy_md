# Story 3.2: Environment Variables & Secrets Governance
**故事 3.2：环境变量与秘密管理治理**

## Status
Ready to review

## Story
**As a** Platform Engineer,
**I want** a governed configuration scheme for live credentials, rate limits, and routing parameters,
**so that** multiple accounts can be managed safely across environments.

## Acceptance Criteria
1. `.env.example` documents primary/backup account variables and rate-limit tuning knobs.
2. Guidance for secure secret storage (Vault, encrypted files) is added to the PRD/architecture.
3. Validation steps ensure misconfigured credentials are detected before startup.

## Tasks / Subtasks
- [x] Update `.env.example` for multi-account configuration governance (AC: 1) [Source: architecture/infrastructure-and-deployment.md#configuration--secrets-governance]
  - [x] Expand the live ingest section with explicit `CTP_PRIMARY_*` and `CTP_BACKUP_*` variable blocks, noting which values stay empty in version control and how operators map them into environment-specific profiles (e.g., `.env.live`). [Source: architecture/infrastructure-and-deployment.md#configuration--secrets-governance]
  - [x] Document rate-limit tuning knobs (`RATE_LIMIT_*`, subscribe window/limit) and monitoring toggles so operators understand how to dial throughput without breaching controls. [Source: architecture/tech-stack.md#technology-stack-table]
  - [x] Cross-link sample secrets handling to the runbook’s pre-market validation step so ops can verify variables before invoking automation. [Source: docs/ops/production-runbook.md#1-pre-market-startup-盘前启动]
- [x] Publish secure secret storage guidance into the product docs (AC: 2) [Source: architecture/security.md#secrets-management]
  - [x] Augment `docs/prd/technical-assumptions-技术假设.md` with a subsection that describes Vault/encrypted-file flows for primary/backup credentials and references the architecture security plan. [Source: architecture/security.md#secrets-management]
  - [x] Update `docs/architecture/security.md` or `docs/architecture/infrastructure-and-deployment.md` with operator steps for sourcing secrets from Vault into runtime `.env` files, including rotation expectations. [Source: architecture/infrastructure-and-deployment.md#configuration--secrets-governance]
  - [x] Ensure the PRD/architecture guidance explicitly links back to the Epic 3 story so downstream teams can trace where account governance is defined. [Source: docs/prd/epics-史诗.md#story-32-environment-variables--secrets-governance]
- [x] Implement startup validation and tooling for configuration governance (AC: 3) [Source: architecture/components.md#configuration-registry]
  - [x] Extend `src/config.py:AppSettings` with structured primary/backup credential fields, route selectors, and rate-limit knobs that mirror the documented `.env` layout while masking sensitive values in `to_dict_safe()`. [Source: architecture/components.md#configuration-registry]
  - [x] Add Pydantic validators or helper methods that surface missing or malformed credentials (e.g., enforcing `tcp://` prefixes, ensuring backup credentials are paired) before orchestration starts. [Source: architecture/infrastructure-and-deployment.md#configuration--secrets-governance]
  - [x] Provide a CLI entry point (e.g., `scripts/operations/validate_env.py`) or extend the existing orchestration pre-flight command to load `AppSettings` and exit non-zero when validation fails, matching the runbook validation workflow. [Source: docs/ops/production-runbook.md#1-pre-market-startup-盘前启动]
  - [x] Expand `tests/unit/operations/test_config_validation.py` (or equivalent) with pytest cases that cover missing secrets, mismatched backup profiles, and successful Vault-simulated loads. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]

## Dev Notes

### Previous Story Insights
- Story 3.1 confirmed that live orchestration depends on `.env` profiles carrying rate-limit hooks and credential handling, so this story must keep those interfaces intact for `start_live_env.sh`. [Source: docs/stories/3.1.story.md#previous-story-insights]
- Operational automation from Story 3.1 already expects Pydantic-based validation before scripts run, reinforcing the need to centralize credential checks in configuration tooling. [Source: docs/stories/3.1.story.md#technical-constraints]

### Data Models
- `AppSettings` (Pydantic `BaseSettings`) remains the canonical model for environment variables and must be extended to represent both primary and backup credential maps alongside rate-limit knobs. [Source: architecture/components.md#configuration-registry]
- Validation logic relies on BaseSettings surfacing misconfigurations at startup, ensuring orchestrators fail fast when secrets are missing or malformed. [Source: architecture/infrastructure-and-deployment.md#configuration--secrets-governance]

### API Specifications
- No specific guidance found in architecture docs.

### Component Specifications
- The configuration registry component governs `.env` documentation, Pydantic settings, and Vault-ready integration for account governance. [Source: architecture/components.md#configuration-registry]
- Operational automation scripts verify environment readiness before launching services, so validation tooling must integrate with those runbook steps. [Source: docs/ops/production-runbook.md#1-pre-market-startup-盘前启动]
- Secrets management policies require credentials to load via environment variables or Vault-backed files rather than hard-coded values. [Source: architecture/security.md#secrets-management]

### File Locations
- `.env.example` lives at the repository root and should continue to illustrate environment-specific overlays without storing real secrets. [Source: architecture/infrastructure-and-deployment.md#configuration--secrets-governance]
- Configuration models reside in `src/config.py`, and environment validation tooling belongs under the `scripts/` hierarchy defined in the source tree. [Source: architecture/source-tree.md#10-source-tree]
- Product and architecture guidance updates must stay under `docs/prd/` and `docs/architecture/` respectively to keep documentation centralized. [Source: architecture/source-tree.md#10-source-tree]

### Testing Requirements
- Follow pytest-based TDD and assert meaningful behavior when configuration validation succeeds or fails. [Source: architecture/test-strategy-and-standards.md#testing-philosophy]
- Extend existing configuration validation tests to cover backup credential scenarios and Vault-like secret loading flows. [Source: architecture/infrastructure-and-deployment.md#configuration--secrets-governance]
- Keep new tests under `tests/unit/operations/` aligned with the established project structure. [Source: architecture/source-tree.md#10-source-tree]

### Technical Constraints
- Never commit actual secrets; keep `.env` samples descriptive while directing operators to secure stores. [Source: architecture/security.md#secrets-management]
- Maintain JSON logging and avoid `print()` when emitting validation diagnostics for operator scripts. [Source: architecture/coding-standards.md#critical-rules]
- Ensure configuration timestamps and audit logs preserve Asia/Shanghai timezone conventions when scripts output status. [Source: architecture/coding-standards.md#timezone-guidance]
- Credential rotation playbooks depend on consistent variable names for primary and backup accounts; do not rename values consumed by failover automation. [Source: architecture/infrastructure-and-deployment.md#failover--recovery-strategy]

## Project Structure Notes
- Keep environment samples and validation tooling aligned with the documented source tree: root-level `.env.example`, configuration code in `src/config.py`, scripts in `scripts/operations/` or `scripts/tools/`, and documentation in `docs/prd`/`docs/architecture`. [Source: architecture/source-tree.md#10-source-tree]

## Dev Agent Record

### Agent Model Used
gpt-5.1

### Debug Log References
- `pytest --no-cov tests/unit/operations/test_config_validation.py`
- `pytest --no-cov tests/unit/operations/test_start_live_env.py`

### Completion Notes List
- Updated `.env.example`, PRD, and architecture docs with multi-account guidance, Vault workflow, and cross-links to Story 3.2.
- Extended `AppSettings` with primary/backup profiles, route selector, rate-limit knobs, and masking improvements.
- Added `scripts/operations/validate_env.py` CLI plus new unit coverage to gate startup misconfiguration scenarios.
- Synced `start_live_env.sh` to hydrate canonical CTP variables from primary/backup blocks for backward compatibility，并新增 `ensure_backup_profile_complete` 强制校验，failover 时缺项立即拒绝。
- 扩展 `validate_env.py` 与 orchestration 单测，覆盖 `--require-backup` 校验和 failover 失败路径，锁牢备份治理流程。

### File List
- `.env.example`
- `docs/prd/technical-assumptions-技术假设.md`
- `docs/architecture/security.md`
- `docs/architecture/infrastructure-and-deployment.md`
- `docs/ops/production-runbook.md`
- `src/config.py`
- `scripts/operations/__init__.py`
- `scripts/operations/validate_env.py`
- `scripts/operations/start_live_env.sh`
- `tests/unit/operations/test_config_validation.py`

## QA Results

### Review Date: 2025-09-22

### Reviewer
- Quinn (Test Architect)

### Code Quality Assessment
- Documentation updates satisfy AC 1/2, but the runbook failover path keeps using primary credentials when backup values are missing, so the new governance flow does not guarantee safe switchover.

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✗ Targeted pytest run requires `--no-cov` to avoid the global 80% gate; default invocation fails the job
- All ACs Met: ✗ AC 3 fails because failover can proceed with an incomplete backup profile without any validation error

### Issues & Risks
- **High:** `start_live_env.sh --failover` silently reuses the primary credentials when backup variables are absent, meaning operators believe the backup profile is live while the platform still runs on the primary account. This defeats the story’s safety objective and should fail fast instead. (scripts/operations/start_live_env.sh:126)

### Acceptance Criteria Trace
- AC 1 – `.env.example` documents primary/backup blocks and rate limits: ✓ Verified
- AC 2 – PRD/architecture/runbook now explain Vault workflow and reference Story 3.2: ✓ Verified
- AC 3 – Validation tooling blocks misconfiguration before startup: ✗ Fails (backup failover path does not surface missing secrets)

### Tests Executed
- `pytest tests/unit/operations/test_config_validation.py` → Coverage gate failure (total 6.22% < 80%) despite all tests passing
- `pytest --no-cov tests/unit/operations/test_config_validation.py` → Pass (20 tests)

### Recommended Status
- ✗ Changes Required (blocker: failover validation gap)

### Review Date: 2025-09-22 (Re-Review)

### Reviewer
- Quinn (Test Architect)

### Code Quality Assessment
- Added `ensure_backup_profile_complete` guard in `start_live_env.sh` so any `--failover` or backup-config startup exits immediately when a `CTP_BACKUP_*` value is blank, restoring the safety guarantees for account governance.
- Updated validation CLI tests (`test_validate_env_cli_require_backup_*`) and orchestration tests to cover the backup-required path, preventing regressions.

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ Targeted pytest suite exercises the new backup enforcement in both CLI and runbook script
- All ACs Met: ✓ AC 3 now passes because misconfigured backup credentials block orchestration before startup

### Issues & Risks
- None blocking. Note: running pytest with repo-wide coverage (`pytest tests/...`) still fails the global 80% gate; continue using `--no-cov` for targeted smoke runs until the broader suite lifts coverage.

### Acceptance Criteria Trace
- AC 1 – `.env.example` documents primary/backup blocks and rate limits: ✓ Verified
- AC 2 – PRD/architecture/runbook explain Vault workflow and reference Story 3.2: ✓ Verified
- AC 3 – Validation tooling blocks misconfiguration before startup: ✓ Verified via CLI/tests and failover guard

### Tests Executed
- `pytest --no-cov tests/unit/operations/test_config_validation.py`
- `pytest --no-cov tests/unit/operations/test_start_live_env.py`

### Recommended Status
- ✓ Ready for Done

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 0.1 | Draft story created | Bob (Scrum Master) |
| 2025-09-22 | 0.2 | Implemented environment governance docs, config validation CLI, and tests | James (Developer) |
