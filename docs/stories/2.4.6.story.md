# Story 2.4.6: Deployment & Parameterization Enhancements (Live Mode)
**故事 2.4.6：部署与参数化增强（Live 模式）**

## Status
Done

## Story
**As a** DevOps Engineer,
**I want** clear live‑mode configuration and deployment parameters,
**so that** operators can reliably run the service in live ingest mode with proper secrets.

## Acceptance Criteria
1. docker-compose 与 README 文档化 live 模式环境变量：`MD_RUN_INGEST=1`、`CTP_GATEWAY_CONNECT`、`CTP_SYMBOL`、`CTP_*` 机密、`NATS_URL`、可选鉴权等。
2. 缺失关键变量时，启动阶段输出清晰错误与指引（变量名、配置位置）。
3. 提供本地/预发 live 启动示例命令与资源限制建议。
4. 不破坏 CI 或非 live 工作流。

## Tasks / Subtasks
- [x] 更新 README：Live 模式章节与示例命令（AC: 1, 3）
- [x] docker-compose：澄清 env/secrets；可选 live profile（AC: 1）
- [x] 验证缺参报错信息的可读性（AC: 2）

## Dev Notes
- 推荐关键变量清单：`CTP_BROKER_ID`、`CTP_USER_ID`、`CTP_PASSWORD`、`CTP_MD_ADDRESS`、`CTP_TD_ADDRESS`、`CTP_APP_ID`、`CTP_AUTH_CODE`、`CTP_SYMBOL`、`CTP_GATEWAY_CONNECT`、`NATS_URL`、（可选）`NATS_USER`、`NATS_PASSWORD`。

## Dev Notes
- Keep secrets out of repo; reference environment or secret stores.

## Dev Agent Record

### Agent Model Used
o3-mini (Dev Agent)

### Debug Log References
- On missing config, expect clear error with variable names and next steps.
- live_ingest_startup_error with required_env and configure_in hints

### Completion Notes List
- Added Live Mode section to README with env var matrix, examples (uv/script/compose), and resource limit suggestions.
- Introduced docker-compose live service (profile "live") with entrypoint `python -m src.main`, env_file support, and sensible defaults.
- Improved startup diagnostics in `src/main.py` for missing/misconfigured `CTP_GATEWAY_CONNECT`; added optional env warnings for `CTP_SYMBOL`.
- Enhanced `_load_connector_from_env` to raise ValueError with actionable guidance while preserving exception type for existing tests.
- Updated `.env.example` with commented live-mode variables.
- Tightened unit test to assert readability of missing-config error message.

### File List
- src/main.py (modified)
- docker-compose.yml (modified)
- README.md (modified)
- .env.example (modified)
- tests/unit/test_ingest_main_entry.py (modified)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-10 | 0.1 | Draft story created | Bob (Scrum Master) |
| 2025-09-15 | 1.0 | Live mode docs, compose live profile, and startup diagnostics implemented | James (Dev) |
