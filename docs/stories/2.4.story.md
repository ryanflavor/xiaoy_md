# Story 2.4: End-to-End Data Flow Integration Test

## Status
Done

## Story
**As a** Tech Lead,
**I want** a full end-to-end integration test,
**so that** I can verify the complete data flow from a mock vnpy event to a NATS subscriber.

## Acceptance Criteria
1. Integration test starts the full application composition for data processing and publishing.
2. Uses a mock vnpy gateway to emit a known TickData event exercised through the adapter boundary.
3. Includes a real NATS subscriber client and subscribes to the expected subject.
4. Asserts the subscriber receives the exact data; CI is updated to run this test.

## Tasks / Subtasks
- [x] Create end-to-end integration test (AC: 1, 2, 3, 4)
  - [x] Add test file: `tests/integration/test_end_to_end_market_tick_flow.py` [Source: architecture/source-tree.md]
  - [x] Start an ephemeral NATS container (reuse `tests/integration/test_nats_health_check.py` pattern) with NO auth and capture client port [Source: tests/integration/test_nats_health_check.py]
  - [x] Compose in test process (do NOT change app entry): `CTPGatewayAdapter` + `MarketDataService` + `NATSPublisher`; set `NATS_URL` to ephemeral port [Source: architecture/components.md; architecture/core-workflows.md]
  - [x] Use Option B gateway injection: pass a `gateway_connect(setting, should_shutdown)` function that emits a single known tick from a worker thread; provide `adapter.on_tick` to it via a shared closure or setter [Source: references/vnpy-integration-best-practices.md]
  - [x] Seed `adapter.symbol_contract_map` with base symbol (e.g., `{"IF2312": object()}`) so `on_tick` is accepted [Source: src/infrastructure/ctp_adapter.py]
  - [x] Initialize service with publisher, run `service.process_market_data()` in background task [Source: architecture/core-workflows.md]
  - [x] Connect a real Python NATS subscriber (no auth) to `market.tick.CFFEX.IF2312` and await message [Source: Dev Notes → Subject Naming]
  - [x] Emit vnpy-like TickData via the injected gateway (call through worker) and ensure timestamp normalization to `+08:00` [Source: architecture/coding-standards.md]
  - [x] Assert key fields only (robustness): subject equals `market.tick.CFFEX.IF2312`; payload includes `symbol`, `exchange`=`CFFEX`, `timestamp` endswith `+08:00`; numeric fields serialized as strings [Source: architecture/data-models.md; coding-standards]
  - [x] Cleanup: cancel processing task; `await` disconnects; stop NATS container; on failure, dump last NATS logs and captured message for diagnostics

- [x] Update CI workflow to run the new test (AC: 4)
  - [x] Extend `.github/workflows/ci.yml` integration job to execute `tests/integration/test_end_to_end_market_tick_flow.py` (no-auth path) [Source: .github/workflows/ci.yml]
  - [x] Keep runtime bounded and reliable; reuse existing Docker image fixture and NATS container patterns; NATS wait ≤ 3s; overall ≤ 15s

- [x] Document subject naming and timezone expectations directly in the test for clarity (developer-facing comments) [Source: docs/stories/2.3.story.md]

## Dev Agent Record

### Agent Model Used
o4-mini

### Debug Log References
- .ai/debug-log.md

### Completion Notes List
- Implemented end-to-end integration test composing `CTPGatewayAdapter` + `MarketDataService` + `NATSPublisher` in-process with real `nats-py` subscriber.
- Reused NATS container pattern with accelerated readiness (≤3s) to keep test runtime ≤15s.
- Injected `gateway_connect` to emit a single vnpy-like TickData from the worker thread; seeded `symbol_contract_map` with base and vt symbols to satisfy adapter check.
- Verified subject `market.tick.CFFEX.IF2312`, JSON payload fields, and `+08:00` timestamp.
- Updated CI integration job to run the new test without coverage addopts.

### File List
- tests/integration/test_end_to_end_market_tick_flow.py (added)
- .github/workflows/ci.yml (modified)

## Dev Notes

### Dependencies
- Depends on Story 2.1 (CTP Gateway Adapter), Story 2.2 (Sync-to-Async Event Bridge), and Story 2.3 (NATS Publisher Adapter). Story 2.3 is Done; Story 2.2 is currently Ready for Review — ensure any required fixes do not block this integration scenario.

### Previous Story Insights
- 2.2 implemented the queue bridge from the vnpy `on_tick` thread into the asyncio loop using a bounded `asyncio.Queue` with drop-and-log backpressure [Source: docs/stories/2.2.story.md].
- 2.3 defined the subject naming scheme and payload shape; serialization strategy is JSON by default, and timestamps must carry `+08:00` (Asia/Shanghai) in infrastructure outputs [Source: docs/stories/2.3.story.md].

### Architecture Context

#### Component Interaction Flow
[Source: architecture/core-workflows.md#workflow-processing-a-market-tick]
1. vnpy CTP Gateway emits `on_tick(vnpy_tick)` in a worker thread
2. CTP Adapter translates to `MarketTick` and bridges to async queue
3. Core service validates and orchestrates publish
4. NATS adapter serializes (JSON) and publishes to NATS

#### Ports Interface Definitions
[Source: architecture/components.md#ports-interface-definitions]
- Input: `MarketDataPort` (async stream of `MarketTick` + lifecycle)
- Output: `EventPublisherPort` (here implemented by `NATSPublisher`)

#### Data Model
[Source: architecture/data-models.md#tickdatamodel-pydantic]
- Domain `MarketTick`: `symbol`, `price`, `volume`, `timestamp`, `bid`, `ask` (Pydantic; immutable)

#### File Locations
[Source: architecture/source-tree.md]
- Adapter: `src/infrastructure/ctp_adapter.py`
- Publisher: `src/infrastructure/nats_publisher.py`
- App service: `src/application/services.py`
- Integration tests: `tests/integration/`

#### Technical Constraints
[Source: architecture/coding-standards.md#critical-rules]
- Strict Hexagonal boundaries (no infra imports from domain/app)
- Structured JSON logging only (no `print()`)
- Timezone policy: Asia/Shanghai (`+08:00`) for serialized timestamps
[Source: architecture/tech-stack.md#technology-stack-table]
- Python 3.13 asyncio; NATS/JetStream; pytest 8.x

#### Error Handling & Resilience
[Source: architecture/error-handling-strategy.md#nats-publish-failures]
- Retry with exponential backoff on publish failures
[Source: architecture/error-handling-strategy.md#poison-pill-messages]
- Serialization wrapped in try/except to isolate bad messages

### Subject Naming
- Scheme: `market.tick.{exchange}.{symbol}` (example: `market.tick.CFFEX.IF2312`) [Source: docs/stories/2.3.story.md]
- In the integration test, subscribe to this subject; derive `exchange` from `vt_symbol` suffix after `.` [Source: src/application/services.py]

### Timezone Policy
- Serialized timestamps include `+08:00` (Asia/Shanghai). If vnpy tick has naive or other tz, normalize to China timezone at the adapter boundary; publisher serializes ISO 8601 with offset [Source: architecture/coding-standards.md#critical-rules]

### Example Tick and Expected Message
- Example vnpy-like tick: `symbol="IF2312.CFFEX"`, `last_price=1234.5`, `volume=10`, `bid_price_1=1234.4`, `ask_price_1=1234.6`, `datetime=2025-01-01T09:30:00+08:00`.
- Expected subject: `market.tick.CFFEX.IF2312` [Source: Dev Notes → Subject Naming]
- Expected payload (JSON): includes `symbol`, `exchange`=`CFFEX`, numeric fields stringified as implemented, and `timestamp` with `+08:00`. [Source: src/application/services.py]

### Testing Standards
[Source: architecture/test-strategy-and-standards.md]
- Use pytest; follow AAA; avoid trivial tests.
- Link assertions to ACs in comments.
- Place under `tests/integration/`; keep deterministic with bounded timeouts.

### Project Structure Notes
[Source: architecture/source-tree.md]
- Keep integration test under `tests/integration/` and avoid coupling tests to private internals.
- Prefer constructing the service composition in test code rather than changing app entrypoint; if needed for future stories, introduce a runtime flag to compose `CTPGatewayAdapter` + `NATSPublisher` behind an env guard.

## QA Results

_Pending after implementation_

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-10 | 0.1 | Initial story draft created | Bob (Scrum Master) |
| 2025-09-10 | 1.0 | Implemented E2E market tick flow test and CI update | James (Developer) |
