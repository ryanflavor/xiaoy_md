# Story 2.4.5: Performance Probe & Soak Toolkit
**故事 2.4.5：性能探针与稳态长跑工具**

## Status
Done

## Story
**As a** Performance Engineer,
**I want** a reusable NATS probe and a soak test workflow,
**so that** we can measure real‑time MPS and latency distribution and run a 1‑hour stability test for Story 2.5.

## Acceptance Criteria
1. 提供 `scripts/perf/nats_throughput_probe.py` 订阅 `market.tick.>`，输出滚动 MPS 与延迟统计；支持 JSON/CSV 汇总。
2. 探针支持无鉴权与鉴权 NATS；参数：`--nats-url`、可选 `--user/--password`、`--window`（默认 5s）、`--format`（text|json|csv）、`--out`（可选）。
3. 提供 Soak Runbook（1 小时跑法）与达标标准（≥5,000 mps，错误率阈值明确）。
4. CI 不跑 soak；开发/预发可手工执行。

## Tasks / Subtasks
- [x] 实现探针脚本（可配置窗口与输出格式）（AC: 1, 2）
- [x] 在 `docs/perf/soak-runbook.md` 增加操作手册（AC: 3）
- [ ] 可选：提供容器化探针（AC: 2）

## Dev Notes
- Keep subscriber fast; avoid heavy processing to prevent probe becoming bottleneck.

## Dev Agent Record

### Agent Model Used
o4-mini

### Debug Log References
- Probe emits periodic JSON lines: `event=probe_window` with `window_seconds`, `mps_window`, `latency_ms.{p50,p90,p99,mean,min,max}`, `total`.
- Final summary line: `event=probe_summary` (also written to `--out` when provided).

### Completion Notes List
- Added NATS throughput/latency probe at `scripts/perf/nats_throughput_probe.py` with auth support and rolling window metrics.
- Implemented JSON/CSV summary export via `--format` and `--out`; periodic console JSON for live view.
- Auth parameters `--user/--password` supported; defaults read from `NATS_URL/NATS_USER/NATS_PASSWORD`.
- Wrote soak runbook with 1-hour procedure and pass/fail criteria (≥5,000 mps, <0.1% parse gaps, stable connectivity).
- Optional containerization deferred (non-blocking for ACs).

### File List
- scripts/perf/nats_throughput_probe.py (added)
- docs/perf/soak-runbook.md (added)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-10 | 0.1 | Draft story created | Bob (Scrum Master) |
| 2025-09-15 | 1.0 | Implemented probe and soak runbook | James (Developer) |
