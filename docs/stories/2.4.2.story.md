# Story 2.4.2: Adapter Subscribe/Unsubscribe Implementation
**故事 2.4.2：适配器订阅/退订实现**

## Status
Ready for Review

## Story
**As a** Developer,
**I want** `CTPGatewayAdapter.subscribe/unsubscribe` implemented,
**so that** the service can drive real subscriptions and manage symbol lifecycle.

**作为** 开发者，
**我想** 实现 `CTPGatewayAdapter.subscribe/unsubscribe`，
**以便** 服务层可以驱动真实订阅并管理符号生命周期。

## Acceptance Criteria
1. `CTPGatewayAdapter.subscribe(symbol)` 返回 `MarketDataSubscription`（生成唯一 `subscription_id`），登记活跃订阅并为该 symbol 做好接收准备。
2. `CTPGatewayAdapter.unsubscribe(subscription_id)` 存在则取消；对未知 ID 幂等（仅告警）。
3. 单测覆盖：成功/缺失/无效 symbol、重复订阅、幂等退订。
4. 与 `MarketDataService.subscribe_to_symbol()` 集成正常，不影响现有流程。

## Tasks / Subtasks
- [x] 在 `src/infrastructure/ctp_adapter.py` 实现 `subscribe()` / `unsubscribe()`（AC: 1, 2）
  - [x] 维护内部映射：subscription_id → symbol/exchange（及反查）
  - [x] 预留对 live 连接器的订阅钩子（初期可 no-op；2.4.3 接通）
- [x] 单元测试：`tests/unit/test_ctp_adapter.py` 新增订阅/退订用例（AC: 3）
- [x] 服务流测试：验证 `MarketDataService.subscribe_to_symbol()` 与适配器交互（AC: 4）

## Dependencies
- 前置：2.4.1；后续：2.4.3 使用本能力实现批量订阅

## Dev Notes
- Symbol validation uses existing domain validators; retain Asia/Shanghai timestamp policy unchanged.
- Live connector subscription wiring will be finalized alongside control plane in Story 2.4.3.

## Dev Agent Record

### Agent Model Used
GPT-4o Mini

### Debug Log References
- subscribed (extra: id, symbol, exchange)
- duplicate_subscription (extra: symbol, exchange, id)
- unsubscribed (extra: id)
- unknown_subscription_id (warn)

### Completion Notes List
- Implemented idempotent subscribe() returning existing subscription for same symbol/exchange
- Added internal mappings id→subscription and symbol/exchange→id
- Added live hook placeholders `_subscribe_live_hook` / `_unsubscribe_live_hook` (no-op)
- Implemented unsubscribe() with idempotent behavior for unknown IDs
- Added unit tests for subscribe/unsubscribe and service interaction

### File List
- src/infrastructure/ctp_adapter.py (updated: subscribe/unsubscribe + hooks)
- tests/unit/test_ctp_adapter.py (updated: 2.4.2 tests and expectations)
- tests/unit/test_market_data_service_flow.py (updated: adapter integration test)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-10 | 0.1 | Draft story created | Bob (Scrum Master) |
| 2025-09-11 | 1.0 | Implemented subscribe/unsubscribe with tests; ready for review | James (Dev Agent) |
