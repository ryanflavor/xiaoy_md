# Story 2.4.1: Live Ingest Publishes to NATS
**故事 2.4.1：Live 模式将行情发布到 NATS**

## Status
Ready for Review

## Story
**As a** Tech Lead,
**I want** the live ingest entrypoint to publish market ticks to NATS using the existing publisher and service composition,
**so that** we have a real CTP → Service → NATS pipeline to build on for Story 2.5.

**作为** 技术负责人，
**我想要** 在 Live 模式下用现有 Publisher 和 Service 组合，将 Tick 发布到 NATS，
**以便** 构建 Story 2.5 所需的真实链路（CTP → Service → NATS）。

## Acceptance Criteria
1. 当设置 `MD_RUN_INGEST=1` 且配置 `CTP_GATEWAY_CONNECT` 时，live 入口组合 `CTPGatewayAdapter` + `MarketDataService` + `NATSPublisher`，并发布到 `market.tick.{exchange}.{symbol}`。
2. 尊重环境变量：`NATS_URL`（可无鉴权）、可选 `NATS_USER`/`NATS_PASSWORD`、`CTP_SYMBOL` 作为初始订阅。
3. 日志包含启动、NATS 连接、发布计数与优雅关停。
4. 不回归当前基于 `src/__main__.py` 的健康检查与模拟 E2E 行为。

## Tasks / Subtasks
- [x] 更新 live 入口（`src/main.py`）在 `MD_RUN_INGEST` 标志下组合 `CTPGatewayAdapter` + `MarketDataService` + `NATSPublisher`（AC: 1, 3）
  - [x] 从 `CTP_GATEWAY_CONNECT` 加载连接器并通过 `set_on_tick` 绑定回调（可选）或退回私有属性绑定（AC: 1）
  - [x] 用 `AppSettings` 初始化 `NATSPublisher` 并连接（AC: 1, 2）
  - [x] 创建 `MarketDataService(market_data_port=adapter, publisher_port=publisher)` 并运行 `process_market_data()`（AC: 1）
- [x] 保留现有模拟/演示路径；不修改 `src/__main__.py` 健康检查流（AC: 4）
- [x] 新增轻量集成测试（无鉴权）：起临时 NATS，短时运行 live 组合，断言发生一次发布（AC: 1, 4）

## Dev Notes
- Source references: `architecture/core-workflows.md`, `architecture/components.md`, `docs/stories/2.3.story.md` (subject naming and payload), `src/application/services.py`.
- Use the already‑implemented timezone and serialization rules; no new schema.
- Keep runtime bounded to avoid hanging tests; ensure cancellation and disconnect await paths.

## Dependencies
- 前置：2.4（模拟 E2E 完成）；后续为 2.4.2、2.4.3 提供运行基础

## Dev Agent Record

### Agent Model Used
OpenAI Codex CLI (dev)

### Debug Log References
- Expect logs: service start, NATS connected, publish attempts, shutdown.
- NATSPublisher: "Connected to NATS ..." and health responder setup
- Live entrypoint: "live_ingest_shutdown" with extras {published, failed}

### Completion Notes List
- Implemented live composition in `src/main.py`: CTPGatewayAdapter + MarketDataService + NATSPublisher with MD_RUN_INGEST flag.
- Respected NATS_URL/NATS_USER/NATS_PASSWORD via AppSettings; seeded `CTP_SYMBOL` into adapter contract map for initial routing readiness.
- Added integration test `tests/integration/test_live_ingest_entrypoint.py` and helper `tests/integration/fake_ctp_connector.py` to assert a publish occurs to `market.tick.{exchange}.{symbol}`.
- Validated via test run: 264 passed, 3 skipped; coverage 88.68% (>=80%).

### File List
- src/main.py (modified)
- tests/integration/test_live_ingest_entrypoint.py (added)
- tests/integration/fake_ctp_connector.py (added)

## QA Results

- Decision: PASS
- Reviewer: Quinn (Test Architect & Quality Advisor)
- Date: 2025-09-11

Acceptance Criteria Verification
- AC1: Live composition publishes to `market.tick.{exchange}.{symbol}`
  - Verified by `tests/integration/test_live_ingest_entrypoint.py` using a real NATS container and by `tests/integration/test_end_to_end_market_tick_flow.py`. Routing logic lives in `MarketDataService._process_tick`.
- AC2: Env vars respected (NATS_URL, optional NATS_USER/PASSWORD, CTP_SYMBOL)
  - `NATSPublisher` reads from `AppSettings` (env-backed). Live entry respects `CTP_SYMBOL` (seeded contract map) and vn.py connector performs actual subscribe when used.
- AC3: Logs include startup/connect/publish counts/shutdown
  - `MarketDataService.process_market_data` emits start log; `NATSPublisher` logs connection; live entry logs `live_ingest_shutdown` with publish stats.
- AC4: No regression to `src/__main__.py` flows
  - Full test suite passed; existing health-check and demo behaviors unchanged.

Risk & Observations
- Non-blocking Ruff warnings in new tests (import order, exception style) — advisable follow-up tidy.
- Integration tests rely on Docker for NATS; CI without Docker may require skips.
- Seeding `CTP_SYMBOL` prevents initial tick drops; actual subscribe occurs in the vn.py connector module.

Quality Gate Decision
- PASS — implementation meets acceptance criteria with adequate tests and graceful shutdown behavior. Suggested lint cleanups are advisory.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-10 | 0.1 | Draft story created | Bob (Scrum Master) |
| 2025-09-11 | 1.0 | Implemented live ingest publish path + tests | James (Dev) |
