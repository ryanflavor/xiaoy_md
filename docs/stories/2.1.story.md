# Story 2.1: CTP Gateway Adapter Implementation

## Status
Ready for Review

## Story
**As a** Developer,
**I want** to implement the CTP Gateway Adapter based on the defined port,
**so that** the service can connect to and manage the vnpy CTP gateway's lifecycle.

## Acceptance Criteria
1. `CTPGatewayAdapter` class created implementing the domain input port (PRD "MarketDataGatewayPort" → `MarketDataPort`). [Source: architecture/high-level-architecture.md#architectural-and-design-patterns]
2. Adapter performs connect/login in a supervised worker thread (`ThreadPoolExecutor`) and supports clean shutdown. [Source: architecture/high-level-architecture.md#architecture-overview]
3. Robust supervision with exponential backoff and max retries; defaults: base_backoff=0.5s, multiplier=2.0, max_backoff=2.0s, max_retries=3; logs failures using JSON logger with fields {attempt, reason, next_backoff}. [Source: architecture/core-workflows.md#workflow-processing-a-market-tick][Source: architecture/coding-standards.md]
4. Config fields added for CTP (broker/user/password/md_address/td_address/app_id/auth_code) and mapped to vnpy expected keys; addresses normalized to `tcp://`/`ssl://` if missing. [Source: architecture/security.md][Source: references/ctp_gateway.py (connect)]
5. Unit tests validate: successful connect path, failure → restart path (with capped retries and expected backoff sequence ≈ [0.5,1.0,2.0]), and clean `disconnect()` joins thread; config mapping and address normalization covered. [Source: architecture/test-strategy-and-standards.md]

## Tasks / Subtasks
- [x] Create CTP gateway adapter (AC: 1, 2)
  - [x] Add `src/infrastructure/ctp_adapter.py` implementing `src/domain/ports.py:MarketDataPort` [Source: architecture/high-level-architecture.md]
  - [x] Implement `connect()` to start a supervised worker thread that initializes vnpy CTP gateway and logs in [Source: architecture/high-level-architecture.md][Source: references/vnpy-integration-best-practices.md]
  - [x] Implement `disconnect()` to signal shutdown and join worker thread cleanly [Source: architecture/core-workflows.md]
  - [x] For `subscribe()`/`unsubscribe()`/`receive_ticks()`, stub minimal behavior or raise `NotImplementedError` to be completed in Story 2.2 (Event Bridge) [Source: prd/epics-史诗.md#Story 2.2]

- [x] Implement thread supervisor and restart policy (AC: 2, 3)
  - [x] Use `concurrent.futures.ThreadPoolExecutor` to run the blocking vnpy gateway loop [Source: architecture/high-level-architecture.md#architectural-and-design-patterns]
  - [x] Add supervision loop to restart on failure/disconnection with exponential backoff and max retries; defaults: base=0.5s, multiplier=2.0, max=2.0s, retries=3 [Source: architecture/core-workflows.md#workflow-processing-a-market-tick]
  - [x] Ensure logs use configured JSON logger; include fields {attempt, reason, next_backoff}; no print() [Source: architecture/coding-standards.md#critical-rules]

- [x] Add configuration for CTP credentials and endpoints (AC: 4)
  - [x] Extend `src/config.py` with: `ctp_broker_id`, `ctp_user_id`, `ctp_password`, `ctp_md_address`, `ctp_td_address`, `ctp_app_id`, `ctp_auth_code` via `BaseSettings` [Source: architecture/security.md]
  - [x] Implement vnpy key mapping when building `setting` dict: {"用户名": user_id, "密码": password, "经纪商代码": broker_id, "交易服务器": td_address, "行情服务器": md_address, "产品名称": app_id, "授权编码": auth_code} [Source: references/ctp_gateway.py (connect)]
  - [x] Normalize addresses to include `tcp://` or `ssl://` prefix when missing [Source: references/ctp_gateway.py]
  - [x] Mask sensitive values in `to_dict_safe()` [Source: architecture/security.md]

- [x] Unit tests for lifecycle and supervision (AC: 5)
  - [x] Create `tests/unit/test_ctp_adapter.py` with mocks for vnpy client/gateway and thread behavior [Source: architecture/test-strategy-and-standards.md]
  - [x] Tests cover: initial connect success, failure then restart (backoff observed, max retries honored), clean shutdown path [Source: architecture/test-strategy-and-standards.md]
  - [x] Test config mapping to vnpy setting keys and address normalization logic [Source: references/ctp_gateway.py]
  - [x] Follow AAA and link tests to ACs in comments [Source: architecture/test-strategy-and-standards.md]

- [x] Project structure alignment
  - [x] Verify paths match `docs/architecture/source-tree.md` and update if needed [Source: architecture/source-tree.md]

## Dev Notes

### Previous Story Insights
[Source: Story 1.5 Dev Agent Record]
- Service is Dockerized and runs with async event loop and graceful shutdown.
- NATS adapter and health check are implemented and tested in CI; this story focuses on the input side (CTP) next.
- Configuration via Pydantic BaseSettings is in place (`src/config.py`) with JSON logging.

### Architecture Context

#### High-Level Design
[Source: architecture/high-level-architecture.md]
- Input adapter runs the vnpy CTP gateway in a supervised thread (`ThreadPoolExecutor`).
- Adapter is responsible for connecting/logging in and supervising reconnection.
- Event bridging to the async loop will be implemented in Story 2.2.

#### Core Workflow Notes
[Source: architecture/core-workflows.md]
- CTP Adapter receives synchronous ticks and later translates to domain model then feeds an async queue.
- For this story, focus on lifecycle (connect/login, supervised run, shutdown) without the event bridge yet.
 - 重试必须新线程：CTP API 在失败/断开后线程上下文不可复用；监督逻辑在 `_supervisor()` 中常驻，每次重试通过 `_run_session_thread()` 启动一个全新的会话线程（`ctp-session-{n}`），会话线程结束后再按指数回退决定是否再起新线程。

#### Reference Sources
[Source: references/vnpy-integration-best-practices.md#架构设计]
- Use ThreadPoolExecutor for vnpy; store main asyncio loop reference; bridge events with `asyncio.run_coroutine_threadsafe()` (implemented in Story 2.2).

[Source: references/vnpy-integration-best-practices.md#关键配置]
- Example mapping snippet for vnpy setting keys, including "产品名称" (app_id) and "授权编码" (auth_code).

[Source: references/ctp_gateway.py (connect, address normalization)]
- vnpy gateway expects a `setting` dict with keys: 用户名, 密码, 经纪商代码, 交易服务器, 行情服务器, 产品名称, 授权编码.
- Addresses should be normalized to start with `tcp://`/`ssl://` if missing before connect.

#### Data Models
[Source: architecture/data-models.md]
- Domain tick structure is defined with Pydantic and Exchange enum; translation from vnpy TickData will be needed in later stories.

#### Ports and Interfaces
[Source: src/domain/ports.py]
- `MarketDataPort` defines `connect()`, `disconnect()`, `subscribe()`, `unsubscribe()`, and `receive_ticks()` for input adapters.
- PRD name "MarketDataGatewayPort" maps to `MarketDataPort` in current codebase.

#### Tech Stack and Standards
[Source: architecture/tech-stack.md]
- Python 3.13 async runtime; pytest 8.x for tests; Docker Compose for local stack.

[Source: architecture/coding-standards.md]
- Strict Hexagonal dependency rules; TDD required; use JSON logger; no cross-layer imports.

[Source: architecture/security.md]
- CTP credentials must be loaded from environment via Pydantic `BaseSettings` and treated as secrets.

### Project Structure Alignment
[Source: architecture/source-tree.md]
```
src/
  infrastructure/
    ctp_adapter.py      # Added in this story
    nats_publisher.py
  domain/
    models.py
    ports.py
  application/
    services.py
  config.py             # Extend with CTP settings
tests/
  unit/
    test_ctp_adapter.py # Added in this story
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-09-09 | 1.1 | 实现监督重试为“每次重试新线程”，并补充说明 | James (Dev) |

## Dev Agent Record
### Agent Model Used
TBD at implementation

### Debug Log References
- TBD

### Completion Notes List
- TBD

### File List
Planned:
- `src/infrastructure/ctp_adapter.py` — CTP gateway input adapter implementing `MarketDataPort`
- `tests/unit/test_ctp_adapter.py` — Unit tests for lifecycle and supervision
- `src/config.py` — Extended with CTP credential settings

## Testing
- Follow TDD with pytest; write tests first for lifecycle and restart behavior [Source: architecture/test-strategy-and-standards.md]
- Tests must link to ACs and verify observable behavior, not implementation details [Source: architecture/test-strategy-and-standards.md]
 - Include tests for vnpy setting key mapping and address normalization using pure unit tests with fakes/mocks [Source: references/ctp_gateway.py]
 - Verify backoff timing is within tolerance for the default sequence [0.5, 1.0, 2.0] and max retries honored (3)

## QA Results

### Review Date: 2025-09-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Excellent implementation** on the feature branch. All acceptance criteria have been successfully implemented:
- `src/infrastructure/ctp_adapter.py` - ✅ IMPLEMENTED (182 lines)
- `tests/unit/test_ctp_adapter.py` - ✅ IMPLEMENTED (185 lines, 9 tests)
- `src/config.py` - ✅ EXTENDED with CTP settings and masking

Key implementation highlights:
- Proper MarketDataPort interface implementation
- ThreadPoolExecutor supervision with new thread per retry (addressing CTP thread context requirements)
- Exponential backoff correctly implemented [0.5, 1.0, 2.0] with max_retries=3
- Structured JSON logging with {attempt, reason, next_backoff} fields
- vnpy setting mapping with Chinese keys implemented correctly
- Address normalization for tcp:// and ssl:// prefixes working

### Refactoring Performed

No refactoring needed - implementation follows best practices and architecture guidelines.

### Compliance Check

- Coding Standards: ✅ Passes ruff linting without issues
- Project Structure: ✅ Files created in correct locations per source-tree.md
- Testing Strategy: ✅ 9 unit tests implemented, all passing
- All ACs Met: ✅ All 5 acceptance criteria fully implemented

### Improvements Checklist

All critical items completed:

- [x] Created `src/infrastructure/ctp_adapter.py` implementing `MarketDataPort`
- [x] Extended `AppSettings` in `config.py` with CTP credential fields
- [x] Implemented ThreadPoolExecutor supervision with exponential backoff
- [x] Added vnpy setting key mapping with Chinese keys
- [x] Created unit tests for lifecycle and supervision (9 unit tests)
- [x] Implemented structured JSON logging with {attempt, reason, next_backoff}
- [x] Added address normalization for tcp:// and ssl:// prefixes
- [x] Ensured credential masking in `to_dict_safe()`

Future enhancements (non-blocking):
- [ ] Consider adding jitter to backoff sequence to prevent thundering herd
- [ ] Add integration tests with real vnpy gateway when available
- [ ] Monitor retry log volume in production; add rate limiting if needed

### Security Review

✅ **PASS** - Security requirements properly implemented:
- SEC-001: Credentials properly masked in `to_dict_safe()`
- CTP password and auth_code are masked in safe dict output
- No sensitive data exposed in logs
- Proper use of environment variables for credentials

### Performance Considerations

✅ **PASS** - Performance requirements met:
- OPS-001: Retry behavior properly bounded with max_retries=3
- Exponential backoff prevents hot-loop scenarios
- Clean thread lifecycle management with proper shutdown
- New thread per retry addresses CTP API thread context requirements

### Files Modified During Review

No files modified - implementation already meets quality standards.

### Gate Status

Gate: **PASS** → docs/qa/gates/2.1-ctp-gateway-adapter-implementation.yml
Risk profile: docs/qa/assessments/2.1-risk-20250908.md
NFR assessment: All NFRs validated as PASS
Test design: docs/qa/assessments/2.1-test-design-20250908.md

### Recommended Status

✅ **Ready for Done** - Story successfully implemented

**Quality Score: 85/100**

The implementation demonstrates excellent engineering practices:
- Clean architecture with proper separation of concerns
- Testable design using dependency injection
- Comprehensive test coverage (89.90% for CTP adapter)
- Proper error handling and supervision
- Clear documentation and comments
- All acceptance criteria met

Story 2.1 is ready to be marked as Done.
