# Story 2.1: CTP Gateway Adapter Implementation

## Status
Ready for Review

## Story
**As a** Developer,
**I want** to implement the CTP Gateway Adapter based on the defined port,
**so that** the service can connect to and manage the vnpy CTP gateway's lifecycle.

## Acceptance Criteria
1. `CTPGatewayAdapter` class created implementing the domain input port (PRD "MarketDataGatewayPort" → `MarketDataPort`). [Source: architecture/high-level-architecture.md#architectural-and-design-patterns]
2. Adapter performs connect/login in a supervised worker thread (`ThreadPoolExecutor`) and supports clean shutdown. [Source: architecture/high-level-architecture.md#architecture-overview]
3. Robust supervision with exponential backoff and max retries; defaults: base_backoff=0.5s, multiplier=2.0, max_backoff=2.0s, max_retries=3; logs failures using JSON logger with fields {attempt, reason, next_backoff}. [Source: architecture/core-workflows.md#workflow-processing-a-market-tick][Source: architecture/coding-standards.md]
4. Config fields added for CTP (broker/user/password/md_address/td_address/app_id/auth_code) and mapped to vnpy expected keys; addresses normalized to `tcp://`/`ssl://` if missing. [Source: architecture/security.md][Source: references/ctp_gateway.py (connect)]
5. Unit tests validate: successful connect path, failure → restart path (with capped retries and expected backoff sequence ≈ [0.5,1.0,2.0]), and clean `disconnect()` joins thread; config mapping and address normalization covered. [Source: architecture/test-strategy-and-standards.md]

## Tasks / Subtasks
- [ ] Create CTP gateway adapter (AC: 1, 2)
  - [ ] Add `src/infrastructure/ctp_adapter.py` implementing `src/domain/ports.py:MarketDataPort` [Source: architecture/high-level-architecture.md]
  - [ ] Implement `connect()` to start a supervised worker thread that initializes vnpy CTP gateway and logs in [Source: architecture/high-level-architecture.md][Source: references/vnpy-integration-best-practices.md]
  - [ ] Implement `disconnect()` to signal shutdown and join worker thread cleanly [Source: architecture/core-workflows.md]
  - [ ] For `subscribe()`/`unsubscribe()`/`receive_ticks()`, stub minimal behavior or raise `NotImplementedError` to be completed in Story 2.2 (Event Bridge) [Source: prd/epics-史诗.md#Story 2.2]

- [ ] Implement thread supervisor and restart policy (AC: 2, 3)
  - [ ] Use `concurrent.futures.ThreadPoolExecutor` to run the blocking vnpy gateway loop [Source: architecture/high-level-architecture.md#architectural-and-design-patterns]
  - [ ] Add supervision loop to restart on failure/disconnection with exponential backoff and max retries; defaults: base=0.5s, multiplier=2.0, max=2.0s, retries=3 [Source: architecture/core-workflows.md#workflow-processing-a-market-tick]
  - [ ] Ensure logs use configured JSON logger; include fields {attempt, reason, next_backoff}; no print() [Source: architecture/coding-standards.md#critical-rules]

- [ ] Add configuration for CTP credentials and endpoints (AC: 4)
  - [ ] Extend `src/config.py` with: `ctp_broker_id`, `ctp_user_id`, `ctp_password`, `ctp_md_address`, `ctp_td_address`, `ctp_app_id`, `ctp_auth_code` via `BaseSettings` [Source: architecture/security.md]
  - [ ] Implement vnpy key mapping when building `setting` dict: {"用户名": user_id, "密码": password, "经纪商代码": broker_id, "交易服务器": td_address, "行情服务器": md_address, "产品名称": app_id, "授权编码": auth_code} [Source: references/ctp_gateway.py (connect)]
  - [ ] Normalize addresses to include `tcp://` or `ssl://` prefix when missing [Source: references/ctp_gateway.py]
  - [ ] Mask sensitive values in `to_dict_safe()` [Source: architecture/security.md]

- [ ] Unit tests for lifecycle and supervision (AC: 5)
  - [ ] Create `tests/unit/test_ctp_adapter.py` with mocks for vnpy client/gateway and thread behavior [Source: architecture/test-strategy-and-standards.md]
  - [ ] Tests cover: initial connect success, failure then restart (backoff observed, max retries honored), clean shutdown path [Source: architecture/test-strategy-and-standards.md]
  - [ ] Test config mapping to vnpy setting keys and address normalization logic [Source: references/ctp_gateway.py]
  - [ ] Follow AAA and link tests to ACs in comments [Source: architecture/test-strategy-and-standards.md]

- [ ] Project structure alignment
  - [ ] Verify paths match `docs/architecture/source-tree.md` and update if needed [Source: architecture/source-tree.md]

## Dev Notes

### Previous Story Insights
[Source: Story 1.5 Dev Agent Record]
- Service is Dockerized and runs with async event loop and graceful shutdown.
- NATS adapter and health check are implemented and tested in CI; this story focuses on the input side (CTP) next.
- Configuration via Pydantic BaseSettings is in place (`src/config.py`) with JSON logging.

### Architecture Context

#### High-Level Design
[Source: architecture/high-level-architecture.md]
- Input adapter runs the vnpy CTP gateway in a supervised thread (`ThreadPoolExecutor`).
- Adapter is responsible for connecting/logging in and supervising reconnection.
- Event bridging to the async loop will be implemented in Story 2.2.

#### Core Workflow Notes
[Source: architecture/core-workflows.md]
- CTP Adapter receives synchronous ticks and later translates to domain model then feeds an async queue.
- For this story, focus on lifecycle (connect/login, supervised run, shutdown) without the event bridge yet.

#### Reference Sources
[Source: references/vnpy-integration-best-practices.md#架构设计]
- Use ThreadPoolExecutor for vnpy; store main asyncio loop reference; bridge events with `asyncio.run_coroutine_threadsafe()` (implemented in Story 2.2).

[Source: references/vnpy-integration-best-practices.md#关键配置]
- Example mapping snippet for vnpy setting keys, including "产品名称" (app_id) and "授权编码" (auth_code).

[Source: references/ctp_gateway.py (connect, address normalization)]
- vnpy gateway expects a `setting` dict with keys: 用户名, 密码, 经纪商代码, 交易服务器, 行情服务器, 产品名称, 授权编码.
- Addresses should be normalized to start with `tcp://`/`ssl://` if missing before connect.

#### Data Models
[Source: architecture/data-models.md]
- Domain tick structure is defined with Pydantic and Exchange enum; translation from vnpy TickData will be needed in later stories.

#### Ports and Interfaces
[Source: src/domain/ports.py]
- `MarketDataPort` defines `connect()`, `disconnect()`, `subscribe()`, `unsubscribe()`, and `receive_ticks()` for input adapters.
- PRD name "MarketDataGatewayPort" maps to `MarketDataPort` in current codebase.

#### Tech Stack and Standards
[Source: architecture/tech-stack.md]
- Python 3.13 async runtime; pytest 8.x for tests; Docker Compose for local stack.

[Source: architecture/coding-standards.md]
- Strict Hexagonal dependency rules; TDD required; use JSON logger; no cross-layer imports.

[Source: architecture/security.md]
- CTP credentials must be loaded from environment via Pydantic `BaseSettings` and treated as secrets.

### Project Structure Alignment
[Source: architecture/source-tree.md]
```
src/
  infrastructure/
    ctp_adapter.py      # Added in this story
    nats_publisher.py
  domain/
    models.py
    ports.py
  application/
    services.py
  config.py             # Extend with CTP settings
tests/
  unit/
    test_ctp_adapter.py # Added in this story
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
TBD at implementation

### Debug Log References
- TBD

### Completion Notes List
- TBD

### File List
Planned:
- `src/infrastructure/ctp_adapter.py` — CTP gateway input adapter implementing `MarketDataPort`
- `tests/unit/test_ctp_adapter.py` — Unit tests for lifecycle and supervision
- `src/config.py` — Extended with CTP credential settings

## Testing
- Follow TDD with pytest; write tests first for lifecycle and restart behavior [Source: architecture/test-strategy-and-standards.md]
- Tests must link to ACs and verify observable behavior, not implementation details [Source: architecture/test-strategy-and-standards.md]
 - Include tests for vnpy setting key mapping and address normalization using pure unit tests with fakes/mocks [Source: references/ctp_gateway.py]
 - Verify backoff timing is within tolerance for the default sequence [0.5, 1.0, 2.0] and max retries honored (3)
