# Story 2.1: CTP Gateway Adapter Implementation

## Status
Ready for Review

## Story
**As a** Developer,
**I want** to implement the CTP Gateway Adapter based on the defined port,
**so that** the service can connect to and manage the vnpy CTP gateway's lifecycle.

## Acceptance Criteria
1. `CTPGatewayAdapter` class created implementing the domain input port (PRD "MarketDataGatewayPort" → `MarketDataPort`).
2. Adapter performs connect/login in a supervised worker thread (`ThreadPoolExecutor`) and supports clean shutdown.
3. Robust supervision with exponential backoff and max retries; defaults: base_backoff=0.5s, multiplier=2.0, max_backoff=2.0s, max_retries=3; logs failures using JSON logger with fields {attempt, reason, next_backoff}.
4. Config fields added for CTP (broker/user/password/md_address/td_address/app_id/auth_code) and mapped to vnpy expected keys; addresses normalized to `tcp://`/`ssl://` if missing; secrets masked in safe outputs.
5. Unit tests validate: successful connect path, failure → restart path (with capped retries and expected backoff sequence ≈ [0.5,1.0,2.0]), and clean `disconnect()` joins thread; config mapping and address normalization covered.

## Tasks / Subtasks
- [x] Create CTP gateway adapter (AC: 1, 2)
  - [x] Add `src/infrastructure/ctp_adapter.py` implementing `src/domain/ports.py:MarketDataPort`
  - [x] Implement `connect()` to start a supervised worker thread that initializes vnpy CTP gateway and logs in
  - [x] Implement `disconnect()` to signal shutdown and join worker thread cleanly
  - [x] For `subscribe()`/`unsubscribe()`/`receive_ticks()`, stub minimal behavior or raise `NotImplementedError` for Story 2.2

- [x] Implement thread supervisor and restart policy (AC: 2, 3)
  - [x] Use `concurrent.futures.ThreadPoolExecutor` to run the blocking vnpy gateway loop
  - [x] Add supervision loop to restart on failure/disconnection with exponential backoff and max retries; defaults: base=0.5s, multiplier=2.0, max=2.0s, retries=3
  - [x] Ensure logs use configured JSON logger; include fields {attempt, reason, next_backoff}; no print()

- [x] Add configuration for CTP credentials and endpoints (AC: 4)
  - [x] Extend `src/config.py` with: `ctp_broker_id`, `ctp_user_id`, `ctp_password`, `ctp_md_address`, `ctp_td_address`, `ctp_app_id`, `ctp_auth_code`
  - [x] Implement vnpy key mapping when building `setting` dict: {"用户名": user_id, "密码": password, "经纪商代码": broker_id, "交易服务器": td_address, "行情服务器": md_address, "产品名称": app_id, "授权编码": auth_code}
  - [x] Normalize addresses to include `tcp://` or `ssl://` prefix when missing
  - [x] Mask sensitive values in `to_dict_safe()`

- [x] Unit tests for lifecycle and supervision (AC: 5)
  - [x] Create `tests/unit/test_ctp_adapter.py` with mocks for vnpy client/gateway and thread behavior
  - [x] Tests cover: initial connect success, failure then restart (backoff observed, max retries honored), clean shutdown path
  - [x] Test config mapping to vnpy setting keys and address normalization logic
  - [x] Follow AAA and link tests to ACs in comments

- [x] Project structure alignment
  - [x] Verify paths match `docs/architecture/source-tree.md` and update if needed

## Dev Notes
- Service is Dockerized and runs with async event loop and graceful shutdown.
- NATS adapter and health check exist; this story focuses on the CTP input side.
- Configuration via Pydantic BaseSettings is in place (`src/config.py`) with JSON logging.

## QA Results

### Review Date: 2025-09-09
### Reviewed By: Quinn (Test Architect)

Key highlights:
- Proper MarketDataPort interface implementation
- ThreadPoolExecutor supervision with new thread per retry
- Exponential backoff [0.5, 1.0, 2.0] with max_retries=3
- Structured JSON logging with {attempt, reason, next_backoff}
- vnpy setting mapping with Chinese keys implemented correctly
- Address normalization for tcp:// and ssl:// prefixes working

Compliance:
- Coding Standards: Pass (ruff)
- Type Checking: Pass (mypy)
- Tests: 9 unit tests for adapter, all passing
- All ACs Met: Yes

Gate: PASS (see `docs/qa/gates/2.1-ctp-gateway-adapter-implementation.yml`)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-09-09 | 1.1 | 实现监督重试为“每次重试新线程”，并补充说明 | James (Dev) |
