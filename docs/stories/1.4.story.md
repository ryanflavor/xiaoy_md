# Story 1.4: Service Dockerization & Build Verification

## Status
Draft

## Story
**As an** SRE,
**I want** the runnable application shell to be packaged in a Docker image and have the build process verified in CI,
**so that** the service artifact is standardized.

## Acceptance Criteria
1. Multi-stage Dockerfile created
2. CI pipeline is updated to build the Docker image after quality checks pass (does not push)

## Tasks / Subtasks
- [ ] Create multi-stage Dockerfile (AC: 1)
  - [ ] Create Dockerfile in project root with multi-stage build pattern
  - [ ] First stage: Use python:3.13-slim as base for dependency installation
  - [ ] Install uv package manager in build stage
  - [ ] Copy pyproject.toml and uv.lock for dependency installation
  - [ ] Second stage: Use python:3.13-slim as runtime base
  - [ ] Copy installed dependencies and application code from build stage
  - [ ] Set proper Python path and environment variables
  - [ ] Configure entry point as `python -m src`
  - [ ] Ensure non-root user execution for security
  - [ ] Add health check command using HEALTHCHECK instruction
- [ ] Create .dockerignore file (AC: 1)
  - [ ] Exclude development artifacts (__pycache__, .pytest_cache, *.pyc)
  - [ ] Exclude version control files (.git, .github)
  - [ ] Exclude test files and directories
  - [ ] Exclude documentation files
  - [ ] Exclude local environment files (.env, .venv, venv)
  - [ ] Include only necessary files for runtime
- [ ] Test Docker build locally (AC: 1)
  - [ ] Verify build completes successfully with no errors
  - [ ] Ensure image size is optimized (target <200MB)
  - [ ] Test container starts and runs without errors
  - [ ] Verify application logs are visible via docker logs
  - [ ] Confirm graceful shutdown on SIGTERM
- [ ] Update CI pipeline for Docker build (AC: 2)
  - [ ] Add Docker build step after test suite completion
  - [ ] Build only on successful quality checks (Black, Mypy, tests)
  - [ ] Use Docker Buildx for efficient caching
  - [ ] Tag image with commit SHA for traceability
  - [ ] Add build time limit to prevent hanging builds
  - [ ] Capture and display build logs
  - [ ] Verify build succeeds but do NOT push to registry
- [ ] Add Docker build verification test (AC: 2)
  - [ ] Create simple test to verify Dockerfile syntax
  - [ ] Validate multi-stage build structure
  - [ ] Ensure all required files are copied correctly
  - [ ] Test that container can be created from built image
  - [ ] Add test to CI pipeline

## Dev Notes

### Previous Story Insights
[Source: Story 1.3 Dev Agent Record]
- Full Hexagonal architecture structure implemented with proper layer separation
- Application runs using `python -m src` with async event loop
- Configuration uses Pydantic BaseSettings with environment variable support
- JSON logging configured with pythonjsonlogger
- Graceful shutdown handling for SIGINT/SIGTERM implemented
- All tests passing with 94.12% coverage
- CI pipeline running Python 3.13 with uv package manager
- Architecture validation integrated and passing

### Project Structure Requirements
[Source: architecture/source-tree.md]
Expected Docker-related files in project root:
```
market-data-service/
├── .dockerignore    # Docker build exclusions
├── Dockerfile       # Multi-stage build definition
├── docker-compose.yml  # (Future: for local stack)
└── ...
```

### Technology Stack Requirements
[Source: architecture/tech-stack.md#Technology Stack Table]
- **Runtime**: Python CPython 3.13
- **Package Management**: uv 0.1.x for dependency management
- **IaC Tool**: Docker Compose 2.24.x for standardized deployment
- **Container Registry**: GitHub Container Registry (GHCR) for future image storage
- **Base Image**: Use python:3.13-slim for optimal size/security balance

### CI/CD Pipeline Context
[Source: Current .github/workflows/ci.yml]
Current CI pipeline includes:
- Python 3.13 setup via actions/setup-python@v5
- uv installation via astral-sh/setup-uv@v3 with caching
- Dependencies installed with `uv sync --frozen`
- Quality checks: Black formatting, Mypy type checking
- Architecture validation via check_architecture.py
- Test suite with pytest and coverage reporting
- Timeout of 10 minutes for entire workflow

Docker build should be added after all quality checks pass but before artifact upload.

### Docker Best Practices
[Source: Industry Standards]
- Use multi-stage builds to minimize final image size
- Run as non-root user for security
- Use specific base image tags (python:3.13-slim) not latest
- Leverage build cache with proper layer ordering
- Copy dependency files before source code for better caching
- Use .dockerignore to exclude unnecessary files
- Add HEALTHCHECK for container orchestration
- Set proper signal handling for graceful shutdown

### Configuration Considerations
[Source: src/config.py from Story 1.3]
- Application uses environment variables via pydantic_settings
- Supports .env file loading for local development
- NATS configuration required (nats_url, nats_cluster_id, nats_client_id)
- JSON logging configuration included
- Ensure Docker build preserves environment variable support

### Entry Point Requirements
[Source: src/__main__.py from Story 1.3]
- Application entry point: `python -m src`
- Async event loop initialization with asyncio.run()
- Signal handlers for SIGINT/SIGTERM already implemented
- Logging setup must occur before application start
- Ensure Docker CMD or ENTRYPOINT uses same execution pattern

## Testing

### Test File Location
- Docker build test: `tests/test_docker_build.py`
- Follow existing test structure with unit/ and integration/ subdirectories

### Test Standards
[Source: architecture/test-strategy-and-standards.md]
- Must follow AAA pattern (Arrange, Act, Assert)
- Test behavior, not implementation details
- Include comments linking tests to specific acceptance criteria
- No trivial assertions or vanity checks

### Specific Testing Requirements for This Story
- Test must verify Dockerfile builds successfully
- Test must validate multi-stage structure is correct
- Test must ensure image can create runnable containers
- CI must build Docker image only after all checks pass
- Build process must not push images (local verification only)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-05 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
