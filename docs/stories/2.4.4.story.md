# Story 2.4.4: Throughput & Observability (MPS, Counters, Optional Metrics)
**故事 2.4.4：吞吐与可观测性（MPS、计数器、可选指标）**

## Status
Ready for Review

## Story
**As a** Tech Lead,
**I want** basic throughput and reliability observability,
**so that** we can measure messages/second (MPS), publish failures, and dropped ticks to prepare for Story 2.5 performance goals.

## Acceptance Criteria
1. 服务以约 5 秒滚动窗口输出 MPS（messages per second）与累计计数器：`published_ticks_total`、`dropped_ticks_total`、`failed_publishes_total`。
2. 日志为结构化 JSON，包含 `event=mps_report`、`window_seconds`、`mps_window`、`published_total`、`dropped_total`、`failed_total`、`nats_connected` 等字段。
3. 可选：在 monitoring profile 启用时，通过 Prometheus exporter 或轻量 HTTP 端点暴露指标。
4. 单元测试验证计数器增量与基本 reporter 行为；日志格式做冒烟验证。

## Tasks / Subtasks
- [x] 在服务/发布路径添加计数器与周期 reporter（异步任务）（AC: 1, 2）
- [x] 接线增量点：成功发布、适配器丢弃 tick、发布异常（AC: 1）
- [ ] 可选：监控 profile 下的 Prom 指标（AC: 3）
- [x] 单元测试（AC: 4）

## Dev Notes
- Keep overhead negligible; do not block hot path.
- Respect existing logging standards and Asia/Shanghai timestamp policy for serialized times.

## Dev Agent Record

### Agent Model Used
o4-mini

### Debug Log References
- Expect `mps_report` log every ~5s with counters and windowed metrics.
- Fields: `event`, `window_seconds`, `mps_window`, `published_total`, `dropped_total`, `failed_total`, `nats_connected`.

### Completion Notes List
- Added rolling-window MPS reporter and cumulative counters in `MarketDataService` with negligible overhead.
- Wired increment points: success publish, publish exception, and dropped ticks via adapter exposure.
- Exposed `dropped_ticks` property in `CTPGatewayAdapter`; service reporter reads it for logs.
- Structured JSON logs include `event=mps_report` and required fields; runs on ~5s interval (configurable).
- Added unit test to verify counters increment and smoke-check structured log fields.

### File List
- src/application/services.py (modified)
- src/infrastructure/ctp_adapter.py (modified)
- tests/unit/test_observability_metrics.py (added)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-10 | 0.1 | Draft story created | Bob (Scrum Master) |
| 2025-09-12 | 1.0 | Implemented MPS reporter, counters, and unit test | James (Developer) |
