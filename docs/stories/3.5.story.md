# Story 3.5: Multi-Account & Feed Failover Readiness
**故事 3.5：多账户与行情源故障切换准备**

## Status
Approved

## Story
**As a** Tech Lead,
**I want** documented and tested procedures for swapping to backup CTP accounts or alternate feeds,
**so that** downtime and downstream disruptions are minimized during incidents.

## Acceptance Criteria
1. Configuration supports primary/backup credentials with clear routing precedence.
2. Failover drill documented with expected operator actions and rollback steps.
3. Monitoring hooks confirm downstream consumers remain stable during switchovers.

## Tasks / Subtasks
- [x] Harden multi-account configuration and routing precedence (AC: 1) [Source: docs/architecture/infrastructure-and-deployment.md#failover--recovery-strategy]
  - [x] Extend `src/config.py:AppSettings` with structured primary/backup account profiles (`ctp_primary`, `ctp_backup`, routing mode) that surface through Pydantic validation while masking secrets in safe dumps. [Source: docs/architecture/components.md#configuration-registry]
  - [x] Ensure orchestration scripts (`scripts/operations/start_live_env.sh`, `scripts/operations/full_feed_subscription.py`) honour the active profile (`--config primary|backup`) and log the selected feed in structured output for audit. [Source: docs/architecture/infrastructure-and-deployment.md#operational-automation--runbooks]
  - [x] Update `.env.example` and supporting docs to clarify precedence variables (`ACTIVE_FEED`, `CTP_BACKUP_*`) and how operators promote backup credentials before running automation. [Source: docs/stories/3.2.story.md#tasks--subtasks]
  - [x] Add pytest coverage verifying configuration selection, masking, and script parameter wiring (e.g., tests under `tests/unit/operations/test_start_live_env.py`). [Source: docs/architecture/test-strategy-and-standards.md#testing-philosophy]
- [x] Author and automate the failover drill workflow (AC: 2) [Source: docs/ops/production-runbook.md#4-emergency-failover-紧急故障切换]
  - [x] Provide a scripted drill path (e.g., `start_live_env.sh --drill` or a wrapper script) that executes failover, validates health (`check_feed_health.py --mode enforce`), then performs failback, capturing metrics `md_failover_latency_ms`/`md_failback_latency_ms`. [Source: docs/architecture/core-workflows.md#workflow-feed-failover-drill]
  - [x] Document the drill in `docs/ops/production-runbook.md` (or a dedicated `docs/ops/failover-drill.md`) with operator steps, prerequisites, rollback actions, and audit logging requirements. [Source: docs/ops/production-runbook.md#incident-logging-事件记录模板]
  - [x] Define cadence and success criteria (latency <5s, zero missing contracts) and embed them in the runbook checklist for sign-off. [Source: docs/ops/subscription-check.md#7-checklist-巡检检查清单]
- [x] Validate monitoring and downstream stability signals (AC: 3) [Source: docs/architecture/observability-and-ops.md#metric-catalog]
  - [x] Emit or tag metrics/events during failover/failback (`md_runbook_exit_code`, `md_failover_latency_ms`, `consumer_backlog_messages`) so Grafana annotations correlate switchovers with consumer health. [Source: docs/ops/monitoring-dashboard.md#3-alert-rules-告警规则]
  - [x] Add automated checks (e.g., a drill verification script) that fetch Prometheus metrics post-switch to assert consumer backlog stays within thresholds and alerts auto-resolve. [Source: docs/ops/production-runbook.md#5-routine-health-checks-日常健康巡检]
  - [x] Update dashboard/alert documentation to include the failover stability panel and escalation triggers for downstream impact. [Source: docs/stories/3.3.story.md#tasks--subtasks]
- [x] Expand automated validation coverage (AC: 1, 2, 3) [Source: docs/architecture/test-strategy-and-standards.md#testing-philosophy]
  - [x] Add pytest or integration tests simulating failover/failback in mock mode, asserting configuration routing, metric emission, and drill success criteria. [Source: tests/unit/operations/test_start_live_env.py]
  - [x] Include CI hooks (e.g., `scripts/ci-local.sh --failover-check`) that run the drill in mock mode to prevent regressions before release. [Source: docs/architecture/infrastructure-and-deployment.md#scheduling]
  - [x] Record expected artifacts (logs under `logs/runbooks/`, audit JSON) and ensure tests verify they are produced with Asia/Shanghai timestamps. [Source: docs/architecture/security.md#audit-logging]

## Dev Notes

### Previous Story Insights
- Story 3.1 delivered orchestration and metrics for failover/failback scripts; reuse its Pushgateway hooks and structured logs rather than creating new patterns. [Source: docs/stories/3.1.story.md#component-specifications]
- Story 3.2 introduced governed `.env` profiles and rate-limit knobs; multi-account routing must leverage those canonical keys. [Source: docs/stories/3.2.story.md#technical-constraints]
- Story 3.3 supplies dashboards and alert scaffolding that expect `md_failover_latency_ms` annotations; integrate new drill data with those panels. [Source: docs/stories/3.3.story.md#tasks--subtasks]
- Story 3.4 adds subscription health remediation; invoke `check_feed_health.py` during drills to confirm coverage before declaring success. [Source: docs/stories/3.4.story.md#tasks--subtasks]

### Data Models
- Account routing relies on structured credentials captured via `AppSettings` and `.env` overlays for primary/backup profiles. [Source: docs/architecture/components.md#configuration-registry]
- Failover telemetry must continue emitting `md_failover_latency_ms` and `md_runbook_exit_code` gauges with labels for session window/feed. [Source: docs/architecture/observability-and-ops.md#metric-catalog]

### API Specifications
- Use existing control plane subjects (`md.contracts.list`, `md.subscribe.bulk`) when validating post-failover coverage; no new external APIs required. [Source: docs/architecture/components.md#subscription-health-agent]

### Component Specifications
- Failover & Recovery strategy dictates orchestration steps, metric emission, and rollback expectations; implementation must align with that playbook. [Source: docs/architecture/infrastructure-and-deployment.md#failover--recovery-strategy]
- Security guidance requires credential rotation (failover/failback) be audited and masked in logs. [Source: docs/architecture/security.md#credential-rotation]

### File Locations
- Multi-account configuration lives in `src/config.py` and `.env.example`; automation scripts remain under `scripts/operations/`; runbooks within `docs/ops/`; metrics/dashboards under `docs/ops/templates/grafana/`. [Source: docs/architecture/source-tree.md#10-source-tree]

### Testing Requirements
- Follow pytest AAA practices with deterministic mock mode for drills; ensure tests assert metric payloads, log artifacts, and active profile selection. [Source: docs/architecture/test-strategy-and-standards.md#testing-philosophy]
- Provide smoke drills that run failover/failback in mock mode during CI/local scripts, verifying consumer backlog thresholds and subscription health status. [Source: docs/ops/production-runbook.md#4-emergency-failover-紧急故障切换]

### Technical Constraints
- Maintain JSON logging, Asia/Shanghai timestamps, and secret masking throughout failover automation. [Source: docs/architecture/coding-standards.md#critical-rules]
- Respect rate-limit settings when resubscribing during drills; do not exceed thresholds defined in AppSettings. [Source: docs/architecture/infrastructure-and-deployment.md#configuration--secrets-governance]
- Keep drill automation non-destructive in mock/test environments by supporting `--mock` execution in orchestration scripts. [Source: scripts/operations/start_live_env.sh]

## Project Structure Notes
- Adhere to the documented source tree: configuration updates in `src/`, automation scripts in `scripts/operations/`, documentation in `docs/ops/`, and tests in `tests/unit/operations/`. [Source: docs/architecture/source-tree.md#10-source-tree]

## Dev Agent Record

### Agent Model Used
Codex GPT-5 (CLI)

### Debug Log References
- `pytest --no-cov tests/unit/operations/test_start_live_env.py`
- `pytest --no-cov tests/unit/operations/test_config_validation.py`
- `pytest --no-cov tests/unit/test_config_security.py`

### Completion Notes List
- Consolidated primary/backup credential handling with structured Pydantic profiles and legacy alias support.
- Added `--drill` workflow plus health/metric verification helpers to `start_live_env.sh` and documented the runbook cadence.
- Extended CI helper and unit tests to cover drill execution, timezone guarantees, and configuration masking.

### File List
- `src/config.py`
- `scripts/operations/start_live_env.sh`
- `src/operations/full_feed_subscription.py`
- `.env.example`
- `docs/ops/production-runbook.md`
- `docs/ops/monitoring-dashboard.md`
- `scripts/ci-local.sh`
- `tests/unit/operations/test_start_live_env.py`
- `tests/unit/operations/test_config_validation.py`
- `tests/unit/test_config_security.py`

## QA Results

### Review Date: 2025-09-23

### Reviewer
- Quinn (Test Architect)

### Code Quality Assessment
- Multi-account configuration modeling and documentation look solid, but orchestration flow still has fail-safety gaps that can outage the feed.
- Monitoring drill script mostly aligns with standards; metric parsing needs stronger targeting for the active feed/account.

### Test Coverage
- Verified operations-focused suites: `tests/unit/operations/test_start_live_env.py`, `tests/unit/operations/test_config_validation.py`, `tests/unit/operations/test_check_feed_health.py`, `tests/unit/operations/test_full_feed_subscription_cli.py`.
- `pytest tests/unit/operations -k drill --maxfail=1` currently trips the 80% coverage gate (9.62% vs 80%), so the quick regression command in Dev Notes needs an updated workflow.

### Findings
1. ❌ **High** – `--failover` stops the production stack before checking whether backup credentials are complete, leaving the service offline if any env var is missing; the drill path has the same hazard. (`scripts/operations/start_live_env.sh:503`, `scripts/operations/start_live_env.sh:286`)
2. ⚠️ **Medium** – `verify_consumer_metrics` reads the first `consumer_backlog_messages` sample without filtering by `active_feed`/account labels, so multi-feed Prometheus payloads can yield false positives/negatives. (`scripts/operations/start_live_env.sh:209`)

### Acceptance Criteria
- AC1 ✅ Covered via `AppSettings` restructuring and validation CLI tests (`tests/unit/operations/test_config_validation.py`).
- AC2 ❌ Blocked by the failover shutdown bug above.
- AC3 ⚠️ Partially satisfied; metrics emit, but the drill check can observe the wrong feed when multiple series exist.

### Recommended Status
- Changes Required

### Follow-up Actions
- Validate backup credentials (or auto-roll back to primary) *before* stopping services during `--failover`/`--drill`.
- Filter drill metric verification by feed/account labels (or accept selectors) so it inspects the active switchover stream only.
- Document a pytest invocation that satisfies the 80% coverage gate, or adjust tooling so ops smoke tests can run cleanly.

---

### Review Date: 2025-09-23 (Re-Review)

### Reviewer
- Quinn (Test Architect)

### Code Quality Assessment
- `--failover`, `--failback`, and drill paths now load and validate the target profile before teardown and roll back automatically if the new stack fails to start, preventing prolonged outages. (`scripts/operations/start_live_env.sh:545`, `scripts/operations/start_live_env.sh:623`)
- Drill metric verification accepts feed/account selectors and defaults to the active feed, so multi-feed Prometheus payloads no longer produce false confidence. (`scripts/operations/start_live_env.sh:231`)
- Runbook and tooling document the new workflow, including a helper that runs drill tests without tripping repository-wide coverage gates. (`docs/ops/production-runbook.md:82`, `scripts/operations/run_drill_tests.sh:1`)

### Test Coverage
- `uv run pytest --no-cov tests/unit/test_observability_metrics.py tests/unit/operations/test_full_feed_subscription_cli.py tests/unit/operations/test_start_live_env.py tests/test_documentation.py::TestMonitoringArtifacts`
- `./scripts/operations/run_drill_tests.sh`

### Findings
- ☑️ Previous high-severity failover teardown bug resolved; rollback safeguards active.
- ☑️ Metrics verification now scoped to the active feed/account, eliminating the earlier medium-risk blind spot.

### Acceptance Criteria
- AC1 ✅
- AC2 ✅
- AC3 ✅

### Recommended Status
- Ready for Done

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-22 | 0.1 | Draft story created | Bob (Scrum Master) |
