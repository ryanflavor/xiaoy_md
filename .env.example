# Docker Compose Environment Variables
# Copy this file to .env and adjust values as needed

# ====================
# Environment Mode
# ====================
# Options: development, test, production
ENVIRONMENT=development
DEBUG=false
LOG_LEVEL=INFO
LOG_FORMAT=json

# ====================
# NATS Configuration
# ====================
# NATS container settings
NATS_VERSION=latest
NATS_CONTAINER_NAME=nats

# NATS command - Different for each environment:
# Development: -js -DV (JetStream with debug)
# Production: -c /etc/nats/nats-server.conf (with config file)
# Test: -js (JetStream only)
NATS_COMMAND=-js -DV

# NATS ports
NATS_CLIENT_PORT=4222
NATS_MONITOR_PORT=8222
NATS_CLUSTER_PORT=6222

# NATS connection URL for the service
# Examples:
# - Basic: nats://nats:4222
# - Auth: nats://user:pass@nats:4222  # pragma: allowlist secret
# - TLS: tls://nats:4222
NATS_URL=nats://nats:4222

# NATS authentication (leave empty for no auth)
NATS_USER=
NATS_PASSWORD=  # pragma: allowlist secret

# NATS configuration file (leave empty to use command line options)
# Example: ./config/nats-server.conf
NATS_CONFIG=


# NATS cluster settings
NATS_CLUSTER_ID=market-data-cluster
NATS_CLIENT_ID=market-data-service-1

# NATS logging
NATS_LOG_LEVEL=debug

# ====================
# Service Configuration
# ====================
# Service container settings
SERVICE_IMAGE=market-data-service:local
SERVICE_CONTAINER_NAME=market-data-service


# Development source mount (leave empty in production)
# In development: ./src
# In production: (leave empty)
DEV_SOURCE_MOUNT=

# Logs mount
SOURCE_MOUNT=./logs

# Resource limits
SERVICE_CPU_LIMIT=1
SERVICE_MEMORY_LIMIT=1G
SERVICE_CPU_RESERVE=0.5
SERVICE_MEMORY_RESERVE=512M

# ====================
# Live Ingest Governance (Optional)
# ====================
# Copy this block into environment-specific overlays (e.g. .env.live, .env.backup).
# Leave the sample values empty in version control and populate them only in secured profiles.
# Detailed operator workflow: docs/ops/production-runbook.md#1-pre-market-startup-盘前启动

# Primary CTP account (required for production)
# Operators map these variables into .env.live before invoking the runbook.
CTP_PRIMARY_BROKER_ID=
CTP_PRIMARY_USER_ID=
CTP_PRIMARY_PASSWORD=  # pragma: allowlist secret
CTP_PRIMARY_MD_ADDRESS=
CTP_PRIMARY_TD_ADDRESS=
CTP_PRIMARY_APP_ID=
CTP_PRIMARY_AUTH_CODE=

# Backup CTP account (optional but recommended for failover)
# Populate in .env.backup or a Vault-sourced overlay; keep blanks in git.
# Operators should promote these values into `.env.live` before running
# `start_live_env.sh --config backup` or enabling `CTP_ROUTE_SELECTOR=backup`.
# All backup keys must be defined together; partial configuration will be rejected.
CTP_BACKUP_BROKER_ID=
CTP_BACKUP_USER_ID=
CTP_BACKUP_PASSWORD=  # pragma: allowlist secret
CTP_BACKUP_MD_ADDRESS=
CTP_BACKUP_TD_ADDRESS=
CTP_BACKUP_APP_ID=
CTP_BACKUP_AUTH_CODE=

# Route selector informs automation which profile to activate (primary|backup|auto)
CTP_ROUTE_SELECTOR=primary
# Optional operator override for automation tooling. `start_live_env.sh` will export
# `ACTIVE_FEED` automatically based on `--config`, but setting it here keeps dashboards
# aligned when sourcing the profile manually.
ACTIVE_FEED=

# Subscription controls
# Toggle ingest when running docker compose with --profile live
# MD_RUN_INGEST=1
# Bounded runtime (0 = infinite)
# MD_DURATION_SECONDS=0
# Connector function (module:attr)
# CTP_GATEWAY_CONNECT=src.infrastructure.ctp_live_connector:live_gateway_connect
# Initial vt_symbol subscription (e.g., rb9999.SHFE)
# CTP_SYMBOL=

# Rate-limit governance knobs (tuned per venue policy)
SUBSCRIBE_RATE_LIMIT_WINDOW_SECONDS=2
SUBSCRIBE_RATE_LIMIT_MAX_REQUESTS=50000
RATE_LIMIT_LOGIN_PER_MINUTE=5
RATE_LIMIT_SUBSCRIBE_PER_SECOND=20000

# Monitoring toggles keep observability aligned with rate-limit changes
PUSHGATEWAY_URL=http://localhost:9091
ENABLE_INGEST_METRICS=1
INGEST_METRICS_HOST=0.0.0.0
INGEST_METRICS_PORT=9100
METRICS_FEED_LABEL=
METRICS_ACCOUNT_LABEL=
SUBSCRIPTION_METRICS_HOST=0.0.0.0
SUBSCRIPTION_METRICS_PORT=9101

# Size of ingest queue before ticks are dropped
TICK_QUEUE_MAXSIZE=50000

# ====================
# Operations Console API
# ====================
# Bearer token(s) accepted by the ops-api container. Separate multiple tokens with commas.
OPS_API_TOKENS=local-dev-ops-token
# Allowlisted CORS origins for the UI. Default "*" keeps the API reachable from any LAN host;
# override with comma-separated origins if you need to restrict access.
OPS_API_CORS_ORIGINS=*
# Methods permitted in CORS preflight responses.
OPS_API_CORS_METHODS=GET,POST,OPTIONS
# Exposed port for the ops-api service (container always binds to 9180 internally).
# OPS_API_PORT=9180

# ====================
# Monitoring (Optional)
# ====================
# Prometheus metrics port
METRICS_PORT=7777
EXPORTER_VERSION=latest

# ====================
# Docker Settings
# ====================
# Restart policy: unless-stopped, on-failure, always, no
RESTART_POLICY=unless-stopped

# Network and volume names
NETWORK_NAME=market-data-net
NATS_VOLUME_NAME=market-data-nats-volume

# ====================
# Build Arguments (Optional)
# ====================
# Proxy settings for building behind corporate firewall
HTTP_PROXY=
HTTPS_PROXY=

# ====================
# Environment-Specific Examples
# ====================

# --- DEVELOPMENT ---
# ENVIRONMENT=development
# DEBUG=true
# LOG_LEVEL=DEBUG
# NATS_COMMAND=-js -DV
# DEV_SOURCE_MOUNT=./src
# RESTART_POLICY=unless-stopped

# --- TEST ---
# ENVIRONMENT=test
# DEBUG=false
# LOG_LEVEL=DEBUG
# NATS_COMMAND=-js
# NATS_USER=testuser
# NATS_PASSWORD=testpass
# RESTART_POLICY=on-failure:3

# --- PRODUCTION WITH AUTH ---
# ENVIRONMENT=production
# DEBUG=false
# LOG_LEVEL=INFO
# NATS_COMMAND=-c /etc/nats/nats-server.conf
# NATS_CONFIG=./config/nats-server.conf
# NATS_URL=nats://nats:4222
# NATS_USER=produser
# NATS_PASSWORD=strongpassword
# DEV_SOURCE_MOUNT=
# SERVICE_CPU_LIMIT=2
# SERVICE_MEMORY_LIMIT=2G
# RESTART_POLICY=always

# --- PRODUCTION WITH TLS ---
# ENVIRONMENT=production
# DEBUG=false
# LOG_LEVEL=INFO
# NATS_COMMAND=-c /etc/nats/nats-server-tls.conf
# NATS_CONFIG=./config/nats-server-tls.conf
# NATS_CERTS_PATH=./certs/prod
# NATS_URL=tls://nats:4222
# NATS_USER=produser
# NATS_PASSWORD=strongpassword
# NATS_TLS_CERT=/certs/client-cert.pem
# NATS_TLS_KEY=/certs/client-key.pem
# NATS_TLS_CA=/certs/ca.pem
# SERVICE_CERTS_PATH=./certs/prod
# DEV_SOURCE_MOUNT=
# RESTART_POLICY=always
